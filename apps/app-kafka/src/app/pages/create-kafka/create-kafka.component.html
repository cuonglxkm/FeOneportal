<page-header [breadcrumb]="breadcrumb" [title]="'Tạo mới Kafka'">
  <ng-template #breadcrumb>
    <nz-breadcrumb>
      <nz-breadcrumb-item>
        <a [routerLink]="['/']">Trang chủ</a>
      </nz-breadcrumb-item>
      <nz-breadcrumb-item>
        <a [routerLink]="['/app-kafka']">Kafka</a>
      </nz-breadcrumb-item>
    </nz-breadcrumb>
  </ng-template>
</page-header>

<div nz-row [nzGutter]="16">
  <div nz-col [nzSpan]="16" class="form-new">
    <form nz-form [formGroup]="myform" nzLayout="horizontal" nzLabelAlign="left">
      
      <nz-card class="border-card">
        <h3>Thông tin chung</h3>
        <span nzType="secondary" style="color: #6C757D">Vui lòng hoàn thiện đầy đủ các thông tin vào form bên dưới. <br>
          Các trường thông tin có dấu (<span style="color: #ff4d4f;">*</span>) là các thông tin bắt buộc nhập.
        </span>
        <div nz-row [nzGutter]="24">
          <div nz-col [nzSpan]="12">
            <nz-form-item class="mt-4">
              <nz-form-label [nzSm]="24" [nzXs]="24" nzRequired>Tên Kafka</nz-form-label>
              <nz-form-control [nzErrorTip]="kafkaErrorTpl">
                <nz-input-group class="w-100" nzSize="large">
                  <input nz-input type="text" placeholder="Nhập tên kafka" formControlName="serviceName" id="serviceName"
                    autofocus />
                </nz-input-group>
              </nz-form-control>
              <ng-template #kafkaErrorTpl let-control>
                <ng-container *ngIf="control.hasError('required')">
                  <div>Vui lòng nhập tên dịch vụ Kafka</div>
                </ng-container>
                <ng-container *ngIf="control.hasError('minlength') || control.hasError('maxlength')">
                  <div>Tên Kafka trong khoảng từ 5-50 ký tự</div>
                </ng-container>
                <ng-container *ngIf="control.hasError('pattern')">
                  <div>Tên Kafka chỉ bao gồm các chữ thường, chữ hoa, số và các ký tự _-</div>
                </ng-container>
              </ng-template>
            </nz-form-item>
          </div>

          <div nz-col [nzSpan]="12">
            <nz-form-item class="mt-4">
              <nz-form-label [nzSm]="24" [nzXs]="24" nzRequired>Phiên bản Kafka</nz-form-label>
              <nz-form-control nzErrorTip="Vui lòng chọn phiên bản Kafka">
                <nz-select formControlName="version" *ngFor="let data of listOfKafkaVersion" nzPlaceHolder="Chọn phiên bản Kafka" nzSize="large">
                  <nz-option [nzValue]="data.helmVersion" [nzLabel]="data.apacheKafkaVersion"></nz-option>
                </nz-select>
              </nz-form-control>
            </nz-form-item>
          </div>
        </div>

        <nz-form-item>
          <nz-form-label [nzSm]="24" [nzXs]="24">Mô tả</nz-form-label>
          <nz-form-control nzErrorTip="">
            <textarea formControlName="description" nz-input placeholder="Mô tả dịch vụ" [nzAutosize]="{ minRows: 5, maxRows: 12 }" nzSize="large"></textarea>
          </nz-form-control>
        </nz-form-item>
      </nz-card>
      
      <nz-card class="border-card">
        <h3><b>Các gói dịch vụ</b></h3>
        <nz-tabset nzCentered>
          <nz-tab nzTitle="Gói cấu hình sẵn" (nzClick)="clicktab()">
            <ng-template nz-tab>
              <ngu-carousel #myCarousel [inputs]="carouselConfig" [dataSource]="listOfServicePack" class="carousel-div">
                <div *nguCarouselDef="let item;" class="item">
                  <div class="pack-item" [ngClass]="{ 'choose': item===chooseitem}" (click)="handleChoosePack(item)">
                    <div class="item-header">
                      <div class="item-name">
                        <span>{{item.servicePackName}}</span>
                        <div class="item-price">
                          <div class="price">
                            <span>{{ item.price | CustomCurrency }}</span><br>
                            <span class="unit-price">đ/tháng</span>
                          </div>
                        </div>
                      </div>
                    </div>
                    <div class="item-body">
                      {{item.broker}} Broker - {{item.cpu}} VCPU / <br>
                      {{item.ram}}GB RAM / <br>
                      {{item.storage}}GB SDD
                    </div>
                  </div>
                </div>
                <ul class="myPoint" NguCarouselPoint>
                  <li *ngFor="let j of myCarousel.pointNumbers" [class.active]="j === myCarousel.activePoint" (click)="myCarousel.moveTo(j)"></li>
                </ul>
              </ngu-carousel>
            </ng-template>
          </nz-tab>
          
          <nz-tab nzTitle="Cấu hình tùy chọn">
            <nz-form-item>
              <div nz-col [nzSpan]="4"></div>
              <nz-form-label [nzSm]="4" [nzXs]="24" nzRequired>vCPU</nz-form-label>
              <nz-form-control [nzSm]="8" [nzXs]="24" nzErrorTip="Vui lòng nhập giá trị vCpu">
                <input nz-input type="number" formControlName="vCpu" id="vCpu" autofocus />
              </nz-form-control>
            </nz-form-item>

            <nz-form-item>
              <div nz-col [nzSpan]="4"></div>
              <nz-form-label [nzSm]="4" [nzXs]="24" nzRequired>RAM</nz-form-label>
              <nz-form-control [nzSm]="8" [nzXs]="24" nzErrorTip="Vui lòng nhập giá trị Ram">
                <input nz-input type="number" formControlName="ram" id="ram" autofocus />
              </nz-form-control>
            </nz-form-item>

            <nz-form-item>
              <div nz-col [nzSpan]="4"></div>
              <nz-form-label [nzSm]="4" [nzXs]="24" nzRequired>Storage</nz-form-label>
              <nz-form-control [nzSm]="8" [nzXs]="24" nzErrorTip="Vui lòng nhập giá trị Storage">
                <input nz-input type="number" formControlName="storage" id="storage" autofocus />
              </nz-form-control>
            </nz-form-item>

            <nz-form-item>
              <div nz-col [nzSpan]="4"></div>
              <nz-form-label [nzSm]="4" [nzXs]="24" nzRequired>Broker</nz-form-label>
              <nz-form-control [nzSm]="8" [nzXs]="24" nzErrorTip="Vui lòng nhập số lượng Broker">
                <input nz-input type="number" formControlName="broker" id="broker" autofocus />
              </nz-form-control>
            </nz-form-item>
          </nz-tab>
        </nz-tabset>

        <nz-form-item>
          <nz-form-label [nzXs]="24" [nzSm]="24" nzRequired>Thời hạn sử dụng (tháng)</nz-form-label>
          <nz-form-control [nzXs]="24" [nzSm]="5" nzErrorTip="Vui lòng nhập thời hạn sử dụng">
              <input nz-input type="number" formControlName="usageTime" id="usageTime" autofocus nzSize="large" (change)="onChangeUsageTime()" />
          </nz-form-control>
        </nz-form-item>
      </nz-card>

      <nz-card class="border-card">
        <h3><b>Cấu hình khác</b></h3>
        <nz-radio-group formControlName="configType" (ngModelChange)="onChangeConfig($event)">
          <label nz-radio [nzValue]="0" class="other-config">Cấu hình mặc định <b>(Khuyến nghị)</b></label>
          <label nz-radio [nzValue]="1" class="other-config">Cấu hình tùy chỉnh</label>
        </nz-radio-group>

        <ng-container *ngIf="showCustomConfig">
          <nz-form-item>
            <nz-form-label [nzSm]="10" [nzXs]="24" nzFor="numPartitions" nzRequired>
                num.partitions
                <div class="info-icon" 
                    nzTooltipTitle="Cấu hình quy định số lượng partition (phân vùng) mà một topic có thể có khi nó được tạo. Mỗi partition là một phần của topic và chứa một phần của dữ liệu. Partition giúp Kafka phân phối và xử lý dữ liệu một cách hiệu quả" nzTooltipPlacement="rightTop" nz-tooltip>
                    <span nz-icon nzType="info-circle" nzTheme="fill"></span>
                </div>
            </nz-form-label>
            <nz-form-control [nzErrorTip]="numPartitionsErrorTpl">
                <input type="number" nz-input placeholder="Nhập số partition" 
                    formControlName="numPartitions" (keypress)="isNumber($event)" 
                    id="numPartitions"  />
            </nz-form-control>
            <ng-template #numPartitionsErrorTpl let-control>
                <ng-container *ngIf="control.hasError('required')">
                    Giá trị num.partitions không được để trống
                </ng-container>
                <ng-container *ngIf="control.hasError('min') || control.hasError('max')">
                    Giá trị num.partitions là số nguyên dương và trong khoảng 1-100
                </ng-container>
            </ng-template>
          </nz-form-item>

          <nz-form-item>
              <nz-form-label [nzSm]="10" [nzXs]="24" nzFor="defaultReplicationFactor" nzRequired>
                  default.replication.factor
                  <div class="info-icon" 
                      nzTooltipTitle="Cấu hình quy định số lượng replica mặc định cho một topic khi topic đó được tạo" nzTooltipPlacement="rightTop" nz-tooltip>
                      <span nz-icon nzType="info-circle" nzTheme="fill"></span>
                  </div>
              </nz-form-label>
              <nz-form-control [nzErrorTip]="defaultReplicationFactorTpl">
                  <input type="number" nz-input placeholder="Nhập số default.replication.factor" 
                      formControlName="defaultReplicationFactor" (keypress)="isNumber($event)" 
                      id="defaultReplicationFactor" (ngModelChange)="onChangeReplicationFactorAndMinInsync();" />
              </nz-form-control>
              <ng-template #defaultReplicationFactorTpl let-control>
                  <ng-container *ngIf="control.hasError('required')">
                      Giá trị default.replication.factor không được để trống
                  </ng-container>
                  <ng-container *ngIf="control.hasError('min') || control.hasError('max')">
                      Giá trị default.replication.factor là số nguyên dương và trong khoảng 1-3
                  </ng-container>
              </ng-template>
          </nz-form-item>

          <nz-form-item>
              <nz-form-label [nzSm]="10" [nzXs]="24" nzFor="minInsyncReplicas" nzRequired>
                  min.insync.replicas
                  <div class="info-icon" 
                      nzTooltipTitle="Xác định số lượng tối thiểu các replica của 1 partition mà producer cần đợi xác nhận từ trước khi coi message là đã được ghi an toàn" nzTooltipPlacement="rightTop" nz-tooltip>
                      <span nz-icon nzType="info-circle" nzTheme="fill"></span>
                  </div>
              </nz-form-label>
              <nz-form-control [nzErrorTip]="minInsyncReplicasTpl">
                  <input type="number" nz-input placeholder="Nhập số min.insync.replicas" 
                      formControlName="minInsyncReplicas" (keypress)="isNumber($event)" 
                      id="minInsyncReplicas" (ngModelChange)="onChangeReplicationFactorAndMinInsync()" />
              </nz-form-control>
              <ng-template #minInsyncReplicasTpl let-control>
                  <ng-container *ngIf="control.hasError('invalidvalue')">
                      Giá trị min.insync.replicas cần nhỏ hơn hoặc bằng default.replication.factor
                  </ng-container>
                  <ng-container *ngIf="control.hasError('required')">
                      Giá trị min.insync.replicas không được để trống
                  </ng-container>
                  <ng-container *ngIf="control.hasError('min') || control.hasError('max')">
                      Giá trị min.insync.replicas là số nguyên dương và trong khoảng 1-3
                  </ng-container>
              </ng-template>
          </nz-form-item>

          <nz-form-item>
              <nz-form-label [nzSm]="10" [nzXs]="24" nzFor="offsetTopicReplicationFactor" nzRequired>
                  offset.topic.replication.factor
                  <div class="info-icon" 
                      nzTooltipTitle="Cấu hình quy định số lượng replica mặc định cho topic '__consumer_offsets'; topic này lưu trữ thông tin về offset của consumer, giúp theo dõi vị trí đọc của mỗi consumer trong mỗi partition" nzTooltipPlacement="rightTop" nz-tooltip>
                      <span nz-icon nzType="info-circle" nzTheme="fill"></span>
                  </div>
              </nz-form-label>
              <nz-form-control [nzErrorTip]="offsetTopicReplicationFactorTpl">
                  <input type="number" nz-input placeholder="Nhập số offset.topic.replication.factor" 
                      formControlName="offsetTopicReplicationFactor" (keypress)="isNumber($event)" id="offsetTopicReplicationFactor" />
              </nz-form-control>
              <ng-template #offsetTopicReplicationFactorTpl let-control>
                  <ng-container *ngIf="control.hasError('required')">
                      Giá trị offset.topic.replication.factor không được để trống
                  </ng-container>
                  <ng-container *ngIf="control.hasError('min') || control.hasError('max')">
                      Giá trị offset.topic.replication.factor là số nguyên dương và trong khoảng 1-3
                  </ng-container>
              </ng-template>
          </nz-form-item>

          <nz-form-item>
              <nz-form-label [nzSm]="10" [nzXs]="24" nzFor="logRetentionHours" nzRequired>
                  log.retention.hours
                  <div class="info-icon" 
                      nzTooltipTitle="Cấu hình đặc tả thời gian giữ lại (retention) cho các log của partition trong Kafka; cấu hình này xác định bao lâu dữ liệu log sẽ được giữ lại trước khi bị xóa. Giá trị -1 là không giới hạn" nzTooltipPlacement="rightTop" nz-tooltip>
                      <span nz-icon nzType="info-circle" nzTheme="fill"></span>
                  </div>
              </nz-form-label>
              <nz-form-control [nzErrorTip]="logRetentionHoursTpl">
                  <input type="number" nz-input placeholder="Nhập số log.retention.hours" 
                      formControlName="logRetentionHours"  id="logRetentionHours" />
                      <!-- (keypress)="isNumberInt($event)" -->
              </nz-form-control>
              <ng-template #logRetentionHoursTpl let-control>
                  <ng-container *ngIf="control.hasError('required')">
                      Giá trị log.retention.hours không được để trống
                  </ng-container>
                  <ng-container *ngIf="control.hasError('min') || control.hasError('max')">
                      Giá trị log.retention.hours là số nguyên dương nằm trong khoảng -1 đến 2.147.483.647 
                  </ng-container>
              </ng-template>
          </nz-form-item>

          <nz-form-item>
              <nz-form-label [nzSm]="10" [nzXs]="24" nzFor="logSegmentBytes" nzRequired>
                  log.segment.bytes
                  <div class="info-icon" 
                      nzTooltipTitle="Cấu hình quy định kích thước tối đa của mỗi segment trong log của 1 partition; log trong Kafka được chia thành các segment để quản lý và xóa dữ liệu hiệu quả" nzTooltipPlacement="rightTop" nz-tooltip>
                      <span nz-icon nzType="info-circle" nzTheme="fill"></span>
                  </div>
              </nz-form-label>
              <nz-form-control [nzErrorTip]="logSegmentBytesTpl">
                  <input type="number" nz-input placeholder="Nhập số log.segment.bytes" 
                      formControlName="logSegmentBytes" (keypress)="isNumber($event)" id="logSegmentBytes" />
              </nz-form-control>
              <ng-template #logSegmentBytesTpl let-control>
                  <ng-container *ngIf="control.hasError('required')">
                      Giá trị log.segment.bytes không được để trống
                  </ng-container>
                  <ng-container *ngIf="control.hasError('min') || control.hasError('max')">
                      Giá trị log.segment.bytes là số nguyên dương nằm trong khoảng 1 đến 10.737.418.240 (10GB)
                  </ng-container>
              </ng-template>
          </nz-form-item>
        </ng-container>
      </nz-card>

    </form>
  </div>

  <!-- payment -->
  <div nz-col [nzSpan]="8" class="gutter-row">
    <nz-card class="price-card">
      <h3><b>Thành tiền</b></h3>
      <div nz-row [nzGutter]="8">
        <div nz-col [nzSpan]="12">
          <div class="label-price">Chi phí vCPU</div>
          <div class="label-quantity">300.000 đồng x 3 cái</div>
        </div>
        <div nz-col [nzSpan]="12">
          <div class="value-price">1.000.000 VNĐ</div>
          <div class="unit-total">VNĐ/tháng</div>
        </div>
      </div>
      <nz-divider class="divider-style"></nz-divider>
      <div nz-row [nzGutter]="8">
        <div nz-col [nzSpan]="12">
          <div class="label-price">Chi phí RAM</div>
          <div class="label-quantity">300.000 đồng x 3 cái</div>
        </div>
        <div nz-col [nzSpan]="12">
          <div class="value-price">1.000.000 VNĐ</div>
          <div class="unit-total">VNĐ/tháng</div>
        </div>
      </div>
      <nz-divider class="divider-style"></nz-divider>
      <div nz-row [nzGutter]="8">
        <div nz-col [nzSpan]="12">
          <div class="label-price">Chi phí Storage</div>
          <div class="label-quantity">300.000 đồng x 3 cái</div>
        </div>
        <div nz-col [nzSpan]="12">
          <div class="value-price">1.000.000 VNĐ</div>
          <div class="unit-total">VNĐ/tháng</div>
        </div>
      </div>
      <nz-divider class="divider-style"></nz-divider>
      <div nz-row [nzGutter]="8">
          <div nz-col [nzSpan]="12">
              <div class="label-price">Thời hạn sử dụng</div>
              <div class="label-quantity">- Ngày bắt đầu:</div>
              <div class="label-quantity">- Ngày hết hạn:</div>
          </div>
          <div nz-col [nzSpan]="12">
              <div class="value-usage-time">{{ usageTime }} tháng</div>
              <div class="unit-total" style="margin-bottom: 12px;">{{ createDate | date : 'dd/MM/yyyy' }}</div>
              <div class="unit-total">{{ expiryDate | date : 'dd/MM/yyyy' }}</div>
          </div>
      </div>
      <nz-divider class="divider-style"></nz-divider>

      <div nz-row [nzGutter]="8" class="mt-5 price-panel">
        <div nz-col [nzSpan]="12">
          <div class="label-price">Thành tiền</div>
          <div class="label-quantity"><i>(Đã bao gồm 10% VAT)</i></div>
        </div>
        <div nz-col [nzSpan]="12">
          <div class="value-price total-price">3.000.000 VNĐ</div>
          <div class="unit-total">VNĐ/tháng</div>
        </div>
      </div>

      <div nz-row class="mt-5" [nzGutter]="16" nzJustify="center">
        <div nz-col [nzSpan]="12">
          <button nz-button nzType="default" nzBlock class="border-button" (click)="onCancelCreate()">
            <span nz-icon nzType="close" nzTheme="outline"></span>
            <b> Hủy</b>
          </button>
        </div>

        <div nz-col [nzSpan]="12">
          <button nz-button nzType="primary" nzBlock class="border-button" (click)="onSubmitPayment()"
            [disabled]="myform.invalid">
            <b>Khởi tạo</b>
          </button>
        </div>
      </div>
    </nz-card>
  </div>
</div>