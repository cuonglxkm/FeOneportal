<page-header [breadcrumb]="breadcrumb" [action]="action" [title]="'Nâng cấp dịch vụ: ' + detailCluster?.clusterName">
  <ng-template #breadcrumb>
    <nz-breadcrumb>
      <nz-breadcrumb-item>
        <a [routerLink]="['/']">Trang chủ</a>
      </nz-breadcrumb-item>
      <nz-breadcrumb-item>
        <a [routerLink]="['/app-kubernetes']">Container</a>
      </nz-breadcrumb-item>
      <nz-breadcrumb-item>
        <a [routerLink]="['/app-kubernetes']">Danh sách cluster</a>
      </nz-breadcrumb-item>
      <nz-breadcrumb-item>
        Nâng cấp Cluster: <ng-container *ngIf="detailCluster"><b>{{detailCluster?.clusterName}}</b></ng-container>
      </nz-breadcrumb-item>
    </nz-breadcrumb>
  </ng-template>

  <!-- action -->
  <ng-template #action>
    <div class="alain-custom-action text-right">
      <region-select-dropdown (valueChanged)="onRegionChange($event)" [isDetail]="true"></region-select-dropdown>
      <project-select-dropdown [regionId]="regionId" (valueChanged)="onProjectChange($event)"
        [isDetail]="true"></project-select-dropdown>
    </div>
  </ng-template>
</page-header>

<div nz-row [nzGutter]="16">
  <div nz-col [nzSpan]="16" class="gutter-row">
    <nz-card class="border-card">
      <h3 class="mb-5">Cấu hình nâng cấp</h3>

      <nz-alert
        nzType="warning"
        [nzDescription]="upgradeWarning" nzShowIcon></nz-alert>
      <ng-template #upgradeWarning>
        <span class="warning-description">Khách hàng chỉ có thể nâng cấp cấu hình lên cao hơn mức hiện tại đang sử dụng.</span>
      </ng-template>

      <nz-tabset nzCentered class="mt-5">
        <nz-tab [nzTitle]="titleDefaultPack" (nzClick)="onSelectPackTab()">
          <ng-template nz-tab>
            <ngu-carousel #myCarousel [inputs]="carouselConfig" [dataSource]="listOfServicePack" class="carousel-div">
              <div *nguCarouselDef="let item;" class="item">
                <div class="pack-item" [ngClass]="{'choose': item===chooseItem, 'pack-item-disable': currentPackItem && !(currentPackItem | checkUpgradePack: item)}"
                  (click)="onChoosePack(item)">
                  <div class="item-header" [ngClass]="{'item-header-disable': currentPackItem && !(currentPackItem | checkUpgradePack: item)}">
                    <div class="item-name" [ngClass]="{'item-name-disable': currentPackItem && !(currentPackItem | checkUpgradePack: item)}">
                      <span>{{item.packName}}</span>
                      <div class="item-price">
                        <div class="price">
                          <span>{{ item.price | customCurrency }}</span><br>
                          <span class="unit-price">đ/tháng</span>
                        </div>
                      </div>
                    </div>
                  </div>

                  <div class="item-body">
                    {{item.cpu}}vCPU /
                    {{item.ram}}GB RAM /
                    {{item.rootStorage}}GB {{item.rootStorageName}}
                    <!-- {{item.volumeStorage}}GB {{item.volumeType}} persistent -->
                  </div>
                </div>
              </div>
              <ul class="myPoint" NguCarouselPoint>
                <li *ngFor="let j of myCarousel.pointNumbers" [class.active]="j === myCarousel.activePoint"
                  (click)="myCarousel.moveTo(j)"></li>
              </ul>
            </ngu-carousel>

          </ng-template>
        </nz-tab>

        <ng-template #titleDefaultPack>
          <span>Gói cấu hình sẵn</span>
        </ng-template>

        <nz-tab [nzTitle]="titleCustomizePack" (nzClick)="onSelectCustomPackTab()">
          <ng-template nz-tab>
            <!-- form upgrade -->
            <form nz-form [formGroup]="upgradeForm" nzLayout="vertical" nzLabelAlign="left">
              <div formArrayName="workerGroup" *ngFor="let control of listFormWorker.controls; let i = index;">
                <ng-container [formGroupName]="i">
                  <div nz-row [nzGutter]="16" class="group-border mb-5">
                    <div nz-col [nzSpan]="12">
                      <nz-form-item>
                        <nz-form-label nzFor="workerGroupName">Tên nhóm worker (<span
                            class="required-color">*</span>)</nz-form-label>
                        <nz-form-control [nzErrorTip]="workerGroupNameErrorTpl">
                          <input type="text" nz-input placeholder="Nhập tên nhóm worker"
                            formControlName="workerGroupName" (ngModelChange)="checkDuplicate(i)" id="workerGroupName"
                            nzSize="large" [readonly]="isUsingPackConfig"
                            [ngClass]="{'default-pack': isUsingPackConfig==true}" />
                        </nz-form-control>
                        <ng-template #workerGroupNameErrorTpl let-control>
                          <ng-container *ngIf="control.hasError('required')">
                            Tên nhóm worker không để trống
                          </ng-container>
                          <ng-container *ngIf="control.hasError('duplicateName')">
                            Tên nhóm worker đã tồn tại
                          </ng-container>
                          <ng-container *ngIf="control.hasError('maxlength')">
                            Tên nhóm worker tối đa 16 ký tự
                          </ng-container>
                          <ng-container *ngIf="control.hasError('pattern')">
                            Tên nhóm worker chỉ chứa các ký tự và số viết thường hoặc dấu gạch nối
                          </ng-container>
                        </ng-template>
                      </nz-form-item>

                      <nz-form-item>
                        <nz-form-label nzFor="configType">Cấu hình (<span
                            class="required-color">*</span>)</nz-form-label>
                        <nz-form-control>
                          <nz-select nzShowSearch nzPlaceHolder="Chọn cấu hình" formControlName="configType"
                            id="configType" (ngModelChange)="onSelectWorkerType($event, i)"
                            [nzDisabled]="isUsingPackConfig" nzSize="large">
                            <nz-option *ngFor="let item of listOfWorkerType"
                              nzLabel="{{item.machineName}} ({{item.cpu}} CPU - {{item.ram}} GB RAM)"
                              [nzValue]="item.machineName"></nz-option>
                          </nz-select>
                        </nz-form-control>
                      </nz-form-item>

                      <nz-form-item>
                        <nz-form-control>
                          <!-- not enable on this phase -->
                          <nz-switch formControlName="autoScalingWorker" (ngModelChange)="onChangeAdvancedConfig(i)"
                            class="mr-3" [nzDisabled]="true"></nz-switch><label>Bật Auto Scaling worker</label>
                        </nz-form-control>
                        <small>Hỗ trợ tự động số lượng worker. Số lượng worker thuộc worker tối thiểu - số lượng worker
                          tối
                          đa</small>
                      </nz-form-item>

                      <ng-container *ngIf="isAutoScaleAtIndex(i)">
                        <nz-form-item>
                          <nz-form-label nzFor="nodes">Số node tối thiểu (<span
                              class="required-color">*</span>)</nz-form-label>
                          <nz-form-control [nzErrorTip]="minimumNodeErrorTpl">
                            <input type="text" nz-input placeholder="Nhập số node tối thiểu"
                              formControlName="minimumNode" (keypress)="isNumber($event)"
                              (ngModelChange)="onChangeNodeValue(i)" nzSize="large" />
                          </nz-form-control>
                          <ng-template #minimumNodeErrorTpl let-control>
                            <ng-container *ngIf="control.hasError('required')">
                              Số node tối thiểu không để trống
                            </ng-container>
                            <ng-container *ngIf="control.hasError('invalid')">
                              Số node tối thiểu không lớn hơn số node tối đa
                            </ng-container>
                            <ng-container *ngIf="control.hasError('min') || control.hasError('max')">
                              Số node tối thiểu trong khoảng 1-10
                            </ng-container>
                          </ng-template>
                        </nz-form-item>
                      </ng-container>

                      <nz-form-item>
                        <nz-form-label nzFor="volumeType">Loại ổ cứng</nz-form-label>
                        <nz-form-control>
                          <nz-radio-group formControlName="volumeType" (ngModelChange)="onSelectVolumeType($event, i)"
                            [nzDisabled]="isUsingPackConfig">
                            <ng-container *ngFor="let item of listOfVolumeType">
                              <label nz-radio [nzValue]="item.volumeType" id="volumeType">
                                {{item.volumeTypeName}}
                              </label>
                            </ng-container>
                          </nz-radio-group>
                        </nz-form-control>
                      </nz-form-item>
                    </div>

                    <div nz-col [nzSpan]="12">
                      <nz-form-item>
                        <nz-form-label nzFor="nodes">Số node (<span class="required-color">*</span>)</nz-form-label>
                        <nz-form-control [nzErrorTip]="nodeNumberErrorTpl">
                          <input type="text" nz-input placeholder="Nhập số node" formControlName="nodeNumber"
                            (ngModelChange)="onCalculatePrice()" (keypress)="isNumber($event)"
                            [readonly]="isUsingPackConfig" nzSize="large"
                            [ngClass]="{'default-pack': isUsingPackConfig==true}" />
                        </nz-form-control>
                        <ng-template #nodeNumberErrorTpl let-control>
                          <ng-container *ngIf="control.hasError('required')">
                            Số node không để trống
                          </ng-container>
                          <ng-container *ngIf="control.hasError('min') || control.hasError('max')">
                            Số node trong khoảng từ 1-10
                          </ng-container>
                        </ng-template>
                      </nz-form-item>

                      <nz-form-item>
                        <nz-form-label nzFor="volume">Ổ cứng (GB) (<span
                            class="required-color">*</span>)</nz-form-label>
                        <nz-form-control [nzErrorTip]="volumeStorageErrorTpl">
                          <input type="text" nz-input placeHolder="Nhập dung lượng ổ cứng"
                            formControlName="volumeStorage" (ngModelChange)="onCalculatePrice()" id="volume"
                            (keypress)="isNumber($event)" [readonly]="isUsingPackConfig" nzSize="large"
                            [ngClass]="{'default-pack': isUsingPackConfig==true}" />
                        </nz-form-control>
                        <ng-template #volumeStorageErrorTpl let-control>
                          <ng-container *ngIf="control.hasError('required')">
                            Dung lượng ổ cứng không để trống
                          </ng-container>
                          <ng-container *ngIf="control.hasError('min') || control.hasError('max')">
                            Dung lượng trong khoảng từ 20-1000 (GB)
                          </ng-container>
                        </ng-template>
                      </nz-form-item>

                      <ng-container *ngIf="isAutoScaleAtIndex(i)">
                        <nz-form-item>
                          <nz-form-label nzFor="nodes">Số node tối đa (<span
                              class="required-color">*</span>)</nz-form-label>
                          <nz-form-control [nzErrorTip]="maximumNodeErrorTpl">
                            <input type="text" nz-input placeholder="Nhập số node tối đa" formControlName="maximumNode"
                              (keypress)="isNumber($event)" (ngModelChange)="onChangeNodeValue(i)" nzSize="large" />
                          </nz-form-control>
                          <ng-template #maximumNodeErrorTpl let-control>
                            <ng-container *ngIf="control.hasError('required')">
                              Số node tối đa không để trống
                            </ng-container>
                            <ng-container *ngIf="control.hasError('min') || control.hasError('max')">
                              Số node tối đa trong khoảng từ 1-10
                            </ng-container>
                          </ng-template>
                        </nz-form-item>
                      </ng-container>

                      <div>
                        <!-- remove btn -->
                        <ng-container *ngIf="listFormWorker.length > 1 && !isUsingPackConfig">
                          <button nz-button nzType="text" nzTooltipTitle="Xóa nhóm worker" nzTooltipPlacement="top"
                            nz-tooltip class="borderless delete-icon remove-btn" (click)="removeWorkerGroup(i)">
                            <span nz-icon nzType="delete"></span>
                          </button>
                        </ng-container>
                      </div>
                    </div>
                  </div>
                </ng-container>
              </div>

              <ng-container *ngIf="!isUsingPackConfig">
                <button nz-button nzType="default" class="border-button" (click)="addWorkerGroup()">
                  <span nz-icon>
                    <svg viewBox="64 64 896 896" focusable="false">
                      <path d="M482 152h60q8 0 8 8v704q0 8-8 8h-60q-8 0-8-8V160q0-8 8-8z" />
                      <path d="M176 474h672q8 0 8 8v60q0 8-8 8H176q-8 0-8-8v-60q0-8 8-8z" />
                    </svg>
                  </span>
                  Thêm worker group
                </button>
              </ng-container>
            </form>
          </ng-template>
        </nz-tab>

        <ng-template #titleCustomizePack>
          <span>Cấu hình tùy chọn</span>
        </ng-template>
      </nz-tabset>
    </nz-card>

    <nz-card class="border-card">
      <nz-table [nzTemplateMode]="true">
        <tbody>
          <tr class="borderless">
            <td class="w-30"><label class="weight-600">Cấu hình hiện tại</label></td>
            <td>
              <ng-container *ngIf="currentPackItem; else workerNodeTpl">
                {{currentPackDescription}}
              </ng-container>
              <ng-template #workerNodeTpl>
                
              </ng-template>
            </td>
          </tr>
          <tr class="borderless">
            <td class="w-30"><label class="weight-600">Cấu hình nâng cấp</label></td>
            <td></td>
          </tr>
          <tr class="borderless">
            <td class="w-30"><label class="weight-600">Ngày nâng cấp</label></td>
            <td>{{currentDate | date: 'dd/MM/yyyy'}}</td>
          </tr>
        </tbody>
      </nz-table>
    </nz-card>
  </div>

  <!-- payment tab -->
  <div nz-col [nzSpan]="8" class="gutter-row">
    <nz-affix [nzOffsetTop]="72">
      <nz-card class="border-card price-card">
        <h3 class="mb-3">Chi phí ước tính</h3>


        <div nz-row [nzGutter]="8">
          <div nz-col [nzSpan]="12">
            <div class="ml-3"><label class="weight-600">Chi phí nâng cấp</label></div>
          </div>

          <div nz-col [nzSpan]="12">
            <div class="price-style price-color mr-3">{{10000000 | number: '1.0-0'}} VNĐ</div>
            <div class="price-style unit-color mr-3">VNĐ/tháng</div>
          </div>
        </div>

        <div nz-row [nzGutter]="8" class="mt-5 price-panel">
          <div nz-col [nzSpan]="12">
            <div class="mt-3 ml-3"><label>Thành tiền</label></div>
            <div class="mt-1 ml-3 mb-3 unit-color"><i>(Đã bao gồm 10% VAT)</i></div>
          </div>
          <div nz-col [nzSpan]="12">
            <div class="price-style total-color mt-3 mr-3">{{20000000 | number: '1.0-0'}} VNĐ</div>
            <div class="price-style unit-color mr-3">VNĐ/tháng</div>
          </div>
        </div>

        <div nz-row class="mt-5" [nzGutter]="16" nzJustify="center">
          <div nz-col [nzSpan]="12">
            <button nz-button nzType="default" nzBlock class="border-button" (click)="handleShowModalCancelUpgrade()"
              [disabled]="isSubmitting">
              <span nz-icon nzType="close" nzTheme="outline"></span>
              Hủy
            </button>
          </div>

          <div nz-col [nzSpan]="12">
            <button nz-button nzType="primary" nzBlock class="border-button" (click)="submitUpgrade()"
              [disabled]="isSubmitting">
              <ng-container *ngIf="isSubmitting; else paymentIconTpl">
                <span nz-icon [nzType]="'loading'"></span>
              </ng-container>
              <ng-template #paymentIconTpl>
                <span nz-icon>
                  <svg width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M15.0791 16.4639H2.91941" stroke="white" stroke-width="1.5" stroke-miterlimit="10"
                      stroke-linecap="round" stroke-linejoin="round" />
                    <path d="M14.0063 2.65625L3.99248 13.1055" stroke="white" stroke-width="1.5" stroke-miterlimit="10"
                      stroke-linecap="round" stroke-linejoin="round" />
                    <path d="M14.0063 10.3215V2.65625H6.66046" stroke="white" stroke-width="1.5" stroke-miterlimit="10"
                      stroke-linecap="round" stroke-linejoin="round" />
                  </svg>
                </span>
              </ng-template>
              <span>Nâng cấp</span>
            </button>
          </div>
        </div>
      </nz-card>
    </nz-affix>
  </div>
</div>
