<page-header [breadcrumb]="breadcrumb" [action]="action" [title]="'Gia hạn dịch vụ: ' + detailCluster?.clusterName">
  <ng-template #breadcrumb>
    <nz-breadcrumb>
      <nz-breadcrumb-item>
        <a [routerLink]="['/']">Trang chủ</a>
      </nz-breadcrumb-item>
      <nz-breadcrumb-item>
        <a [routerLink]="['/app-kubernetes']">Container</a>
      </nz-breadcrumb-item>
      <nz-breadcrumb-item>
        <a [routerLink]="['/app-kubernetes']">Danh sách cluster</a>
      </nz-breadcrumb-item>
      <nz-breadcrumb-item>
        Gia hạn dịch vụ: <ng-container *ngIf="detailCluster"><b>{{detailCluster?.clusterName}}</b></ng-container>
      </nz-breadcrumb-item>
    </nz-breadcrumb>
  </ng-template>

  <!-- action -->
  <ng-template #action>
    <div class="alain-custom-action text-right">
      <region-select-dropdown (valueChanged)="onRegionChange($event)" [isDetail]="true"></region-select-dropdown>
      <project-select-dropdown [regionId]="regionId" (valueChanged)="onProjectChange($event)"
        [isDetail]="true"></project-select-dropdown>
    </div>
  </ng-template>
</page-header>

<div nz-row [nzGutter]="16">
  <div nz-col [nzSpan]="16" class="gutter-row">
    <ng-container *ngIf="detailCluster; else loadingClusterTpl">
      <nz-card class="border-card">
        <h3>Thông tin chung</h3>
        <div class="detailtable">
          <nz-table [nzTemplateMode]="true" nzBordered>
            <tbody>
              <tr>
                <td class="w-50"><row-data [value]="detailCluster.clusterName" [label]="'Tên Cluster'"></row-data></td>
                <td class="w-50"><row-data [value]="detailCluster.currentVersion"
                    [label]="'Phiên bản Kubernetes'"></row-data></td>
              </tr>

              <tr>
                <td class="w-50"><row-data [value]="detailCluster.apiEndpoint" [label]="'API Endpoint'"></row-data></td>
                <td class="w-50">
                  <div nz-row>
                    <div nz-col [nzSpan]="8">Mã đơn hàng</div>
                    <div nz-col [nzSpan]="16">
                      <span style="font-size: 16px; font-weight: 600;">
                        <a [routerLink]="'/app-smart-cloud/order/detail/' + detailCluster.orderId"
                          target="_blank">{{detailCluster.orderCode}}</a>
                      </span>
                    </div>
                  </div>
                </td>
              </tr>

              <tr>
                <td class="w-50">
                  <div nz-row>
                    <div nz-col [nzSpan]="8">Trạng thái</div>
                    <div nz-col [nzSpan]="16">
                      <ng-container *ngIf="detailCluster.serviceStatus | status2ColorPipe as status">
                        <span [ngStyle]="{color: status.color, 'font-weight': 600}">{{status.status}}</span>
                      </ng-container>
                    </div>
                  </div>
                </td>
                <td class="w-50"><row-data [value]="detailCluster.description" [label]="'Mô tả'"></row-data></td>
              </tr>

              <tr>
                <td class="w-50"><row-data [value]="detailCluster.createdDate | date: 'dd/MM/yyyy'"
                    [label]="'Ngày khởi tạo'"></row-data></td>
                <td class="w-50"><row-data
                    [value]="(detailCluster.createdDate | calculateDate : detailCluster.usageTime) | date: 'dd/MM/yyyy'"
                    [label]="'Ngày hết hạn'" [type]="'danger'"></row-data></td>
              </tr>

            </tbody>
          </nz-table>
        </div>
      </nz-card>

      <!-- Thông tin worker group -->
      <nz-card class="border-card">
        <h3>Thông tin nhóm worker</h3>
        <ng-container *ngFor="let item of detailCluster.workerGroup ; let i = index;">
          <div nz-row>
            <div nz-col [nzSpan]="24" class="detailtable">
              <nz-table [nzTemplateMode]="true" nzBordered>
                <tbody>
                  <tr>
                    <td class="w-50"><row-data [value]="item.workerGroupName" [label]="'Tên nhóm worker'"></row-data>
                    </td>
                    <td class="w-50"><row-data [value]="item.minimumNode" [label]="'Số node'"></row-data></td>
                  </tr>

                  <tr>
                    <td class="w-50"><row-data [value]="item.cpu + 'vCPU / ' + item.ram + 'GB'"
                        [label]="'Cấu hình'"></row-data></td>
                    <td class="w-50"><row-data [value]="item.volumeSize" [label]="'Ổ cứng (GB)'"></row-data></td>
                  </tr>

                  <tr>
                    <td class="w-50">
                      <div nz-row>
                        <div nz-col [nzSpan]="8">Auto scale</div>
                        <div nz-col [nzSpan]="16" class="description-info">
                          <span class="weight-600">{{item.autoScalingWorker == true ? 'Bật': 'Tắt'}}</span>
                        </div>
                      </div>
                    </td>

                    <td class="w-50"><row-data [value]="item.volumeTypeName" [label]="'Loại ổ cứng'"></row-data></td>
                  </tr>

                  <ng-container *ngIf="isAutoScale">
                    <tr>
                      <td class="w-50"><row-data [value]="item.minimumNode" [label]="'Minimum node'"></row-data></td>
                      <td class="w-50"><row-data [value]="item.maximumNode" [label]="'Maximum node'"></row-data></td>
                    </tr>
                  </ng-container>
                </tbody>
              </nz-table>
            </div>

            <ng-container *ngIf="detailCluster?.workerGroup.length > 0 && i != detailCluster?.workerGroup.length - 1">
              <nz-divider nzDashed></nz-divider>
            </ng-container>
          </div>
        </ng-container>
      </nz-card>

      <!-- Thông tin network -->
      <nz-card class="border-card">
        <h3>Thông tin network</h3>
        <div nz-row>
          <div nz-col [nzSpan]="24" class="detailtable">
            <nz-table [nzTemplateMode]="true" nzBordered>
              <tbody>
                <tr>
                  <td class="w-50"><row-data [value]="detailCluster.networkType | network2label"
                      [label]="'Loại network'"></row-data></td>
                  <td class="w-50"><row-data [value]="detailCluster.cidr" [label]="'Pod CIDR'"></row-data></td>
                </tr>

                <tr>
                  <td class="w-50"><row-data [value]="vpcNetwork" [label]="'Mạng VPC'"></row-data></td>
                  <td class="w-50"><row-data [value]="detailCluster.serviceCidr" [label]="'Service CIDR'"></row-data>
                  </td>
                </tr>

                <tr>
                  <td class="w-50"><row-data [value]="detailCluster.subnet" [label]="'Subnet'"></row-data></td>
                </tr>
              </tbody>
            </nz-table>
          </div>
        </div>
      </nz-card>
    </ng-container>
    <ng-template #loadingClusterTpl>
      <nz-card class="border-card">
        <nz-table [nzTemplateMode]="true" [nzLoading]="true">
        </nz-table>
      </nz-card>
    </ng-template>

    <nz-card class="border-card">
      <h3>Thông tin gia hạn</h3>

      <div nz-row [nzGutter]="16">
        <div nz-col [nzSpan]="12">
          <div nz-row [nzGutter]="16">
            <div nz-col [nzSpan]="8"><label>Ngày khởi tạo dịch vụ</label></div>
            <div nz-col [nzSpan]="16"><label class="weight-600">{{detailCluster?.createdDate | date: 'dd/MM/yyyy'}}</label></div>
          </div>
        </div>

        <div nz-col [nzSpan]="12">
          <div nz-row [nzGutter]="16">
            <div nz-col [nzSpan]="8"><label>Ngày hết hạn</label></div>
            <div nz-col [nzSpan]="16"><label class="weight-600">{{expiryDate | date: 'dd/MM/yyyy'}}</label></div>
          </div>
        </div>
      </div>

      <div class="mt-3">
        <label>Số tháng cần gia hạn thêm (<span class="required-color">*</span>)</label>
        <input type="number" nz-input placeholder="Nhập số tháng cần gia hạn"
          [(ngModel)]="extendMonth" (ngModelChange)="onSelectUsageTime($event)" nzSize="large" />
      </div>

      <div class="mt-3 delete-icon">
        <label>Ngày hết hạn dự kiến: {{expectedExpirationDate | date: 'dd/MM/yyyy'}}</label>
      </div>
    </nz-card>

  </div>

  <!-- payment tab -->
  <div nz-col [nzSpan]="8" class="gutter-row">
    <nz-affix [nzOffsetTop]="72">
      <nz-card class="border-card price-card">
        <h3 class="mb-3">Chi phí ước tính</h3>

        <div nz-row [nzGutter]="8">
          <div nz-col [nzSpan]="12">
            <div class="ml-3 mb-3"><label class="weight-600">Tên dịch vụ</label></div>
          </div>

          <div nz-col [nzSpan]="12">
            <div class="price-style mr-3 mb-3">{{detailCluster?.clusterName}}</div>
          </div>
        </div>

        <div nz-row [nzGutter]="8">
          <div nz-col [nzSpan]="12">
            <div class="ml-3 mb-3"><label class="weight-600">Phiên bản</label></div>
          </div>

          <div nz-col [nzSpan]="12">
            <div class="price-style mr-3 mb-3">{{detailCluster?.currentVersion}}</div>
          </div>
        </div>

        <div nz-row [nzGutter]="8">
          <ng-container *ngIf="currentPack; else customPackSummaryTpl">
            <div nz-col [nzSpan]="12">
              <div class="ml-3 mb-3"><label class="weight-600">Gói dịch vụ: <b>{{currentPack.packName}}</b></label>
              </div>
            </div>

            <div nz-col [nzSpan]="12">
              <div class="mr-3 summary-info">
                {{currentPack.cpu}}vCPU / {{currentPack.ram}}GB / {{currentPack.rootStorage}}GB
                {{currentPack.rootStorageName}}
              </div>
            </div>
          </ng-container>
          <ng-template #customPackSummaryTpl>
            <div nz-col [nzSpan]="12">
              <div class="ml-3 mb-3"><label class="weight-600">Thông tin nhóm worker</label></div>
            </div>

            <div nz-col [nzSpan]="12">
              <ng-container *ngFor="let item of detailCluster?.workerGroup">
                <div class="mb-3">
                  {{item.workerGroupName}} / {{item.cpu}}vCPU / {{item.ram}}GB / {{item.volumeSize}}GB {{item.volumeTypeName}}
                </div>
              </ng-container>
            </div>
          </ng-template>
        </div>

        <nz-divider class="divider-style"></nz-divider>

        <div nz-row [nzGutter]="8">
          <div nz-col [nzSpan]="12">
            <div class="ml-3"><label class="weight-600">Chi phí 1 tháng</label></div>
          </div>

          <div nz-col [nzSpan]="12">
            <div class="price-style price-color mr-3">{{(costPerMonth ? costPerMonth : 0) | number: '1.0-0'}} VNĐ
            </div>
            <div class="price-style unit-color mr-3 mb-3">VNĐ/tháng</div>
          </div>
        </div>

        <div nz-row [nzGutter]="8">
          <div nz-col [nzSpan]="12">
            <div class="ml-3"><label class="weight-600">Chi phí VAT (10%)</label></div>
          </div>

          <div nz-col [nzSpan]="12">
            <div class="price-style price-color mr-3">{{(vatCost ? vatCost : 0) | number: '1.0-0'}} VNĐ</div>
            <div class="price-style unit-color mr-3">VNĐ/tháng</div>
          </div>
        </div>

        <div nz-row [nzGutter]="8" class="mt-5 price-panel">
          <div nz-col [nzSpan]="12">
            <div class="mt-3 ml-3"><label class="weight-600">Tổng cần thanh toán</label></div>
            <div class="mt-1 ml-3 mb-3 unit-color"><i>(Đã bao gồm 10% VAT)</i></div>
          </div>
          <div nz-col [nzSpan]="12">
            <div class="price-style total-color mt-3 mr-3">{{(totalCost && totalCost > 0 ? totalCost : 0) | number: '1.0-0'}} VNĐ</div>
            <div class="price-style unit-color mr-3">VNĐ/tháng</div>
          </div>
        </div>

        <div nz-row class="mt-5" [nzGutter]="16" nzJustify="center">
          <div nz-col [nzSpan]="12">
            <button nz-button nzType="default" nzBlock class="border-button" (click)="showModalCancelExtend()"
              [disabled]="isSubmitting">
              <span nz-icon nzType="close" nzTheme="outline"></span>
              Hủy
            </button>
          </div>

          <div nz-col [nzSpan]="12">
            <button nz-button nzType="primary" nzBlock class="border-button" (click)="onExtendService()"
              [disabled]="isSubmitting || this.extendMonth == null || this.extendMonth == undefined || detailCluster?.serviceStatus != 2">
              <ng-container *ngIf="isSubmitting; else paymentIconTpl">
                <span nz-icon [nzType]="'loading'"></span>
              </ng-container>
              <ng-template #paymentIconTpl>
                <span nz-icon>
                  <svg width="22" height="21" viewBox="0 0 25 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M8.5 2V5" stroke="#989BB3" stroke-width="1.5" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M16.5 2V5" stroke="#989BB3" stroke-width="1.5" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M4 9.09009H21" stroke="#989BB3" stroke-width="1.5" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M21.5 8.5V17C21.5 20 20 22 16.5 22H8.5C5 22 3.5 20 3.5 17V8.5C3.5 5.5 5 3.5 8.5 3.5H16.5C20 3.5 21.5 5.5 21.5 8.5Z" stroke="#989BB3" stroke-width="1.5" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M16.1947 13.7H16.2037" stroke="#989BB3" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M16.1947 16.7H16.2037" stroke="#989BB3" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M12.4955 13.7H12.5045" stroke="#989BB3" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M12.4955 16.7H12.5045" stroke="#989BB3" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M8.79431 13.7H8.80329" stroke="#989BB3" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M8.79431 16.7H8.80329" stroke="#989BB3" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </span>
              </ng-template>
              <span>Gia hạn</span>
            </button>
          </div>
        </div>

      </nz-card>
    </nz-affix>
  </div>
</div>

<!-- modal cancel upgrade -->
<nz-modal [(nzVisible)]="isShowModalCancelExtend" [nzTitle]="modalTitle" [nzContent]="modalContent"
  [nzFooter]="modalFooter" (nzOnCancel)="handleCancelModal()">
  <ng-template #modalTitle>Đang tiến hành thanh toán</ng-template>

  <ng-template #modalContent>
    <nz-alert nzType="warning" [nzDescription]="cancelWarning" nzShowIcon></nz-alert>
    <ng-template #cancelWarning>
      <div class="warning-description">Thanh toán của bạn đang được thực hiện, nếu bạn thoát khỏi trang này, giao dịch
        sẽ bị hủy bỏ.</div>
      <div class="delete-color warning-description mt-1">Bạn có chắc chắn muốn thoát khỏi trang này?</div>
    </ng-template>
  </ng-template>

  <ng-template #modalFooter>
    <button nz-button nzType="default" (click)="handleCancelModal()" [disabled]="isSubmitDelete">
      <span nz-icon nzType="close" nzTheme="outline"></span>
      Hủy
    </button>
    <button nz-button nzType="primary" (click)="back2list()">
      <span nz-icon nzType="check" nzTheme="outline"></span>
      Xác nhận
    </button>
  </ng-template>
</nz-modal>
