<page-header [breadcrumb]="breadcrumb"
             [action]="action"
             [title]="'Snapshot Volume'" xmlns="http://www.w3.org/1999/html">
  <ng-template #breadcrumb>
    <nz-breadcrumb [nzSeparator]="iconTemplate">
      <ng-template #iconTemplate><one-portal-svg-icon [icon]="'icon_breadcrumb'"></one-portal-svg-icon></ng-template>
      <nz-breadcrumb-item><a [routerLink]="['/']">{{ 'app.breadcrumb.home' | i18n }}</a></nz-breadcrumb-item>
      <nz-breadcrumb-item>{{'app.breadcrumb.infrastructure.service' | i18n }}</nz-breadcrumb-item>
      <nz-breadcrumb-item>Block Storage</nz-breadcrumb-item>
      <nz-breadcrumb-item><a routerLink="/app-smart-cloud/snapshot">Snapshot Volume</a></nz-breadcrumb-item>
    </nz-breadcrumb>
    <ng-template #separatorTemplate
    ><img src="assets/imgs/arrow-square-right.svg" alt="" />
    </ng-template>
  </ng-template>
  <ng-template #action>
    <div class="alain-custom-action text-right">
      <share-users-combobox></share-users-combobox>
      <region-select-dropdown (regionChange)="onRegionChanged($event)" (valueChanged)="regionChanged($event)"></region-select-dropdown>
      <project-select-dropdown #projectCombobox (valueChanged)="projectChanged($event)"
                               (userChanged)="projectChanged($event)"
                               [regionId]="region"></project-select-dropdown>
    </div>
  </ng-template>
</page-header>
<nz-content>
  <nz-card>
    <ng-container [ngSwitch]="isBegin">
      <ng-container *ngSwitchCase="false">
        <nz-row nzJustify="space-between">
          <nz-col nzSpan="12">
            <!--            <span class="text-card-header">{{ 'app.load.balancer.list' | i18n }}</span>-->
            <nz-select [(ngModel)]="status" (ngModelChange)="search(false)" nzSize="large" style="width: 200px">
              <nz-option *ngFor="let p of listStatus" [nzValue]="p.value" [nzLabel]="p.label"></nz-option>
            </nz-select>
            <nz-input-group style="width: 350px; margin-left: 15px;" [nzPrefix]="prefixIconSearch" nzSize="large">
              <input name="name"
                     nz-input
                     [(ngModel)]="value"
                     (ngModelChange)="searchDelay.next(false)"
                     [placeholder]="'menu.search' | i18n"
                     (keydown.enter)="search(false)"/>
            </nz-input-group>
            <ng-template #prefixIconSearch>
              <img src="assets/imgs/search.svg" alt="" style="cursor: pointer" />
            </ng-template>
          </nz-col>
          <nz-col nzSpan="12" style="flex:none;">
            <button nz-button nzType="primary" nzSize="large" (click)="navigateToCreate()">
              <img style="padding-right: 10px; margin-top: -4px" src="assets/imgs/add-circle.svg" alt="" />
              <span class="button-text-primary">Tạo mới Snapshot</span>
            </button>
          </nz-col>
        </nz-row>
        <nz-table #fixedTable
                  nzShowSizeChanger
                  style="margin-top: 20px;"
                  [nzData]="response?.records || []"
                  [nzPageSize]="size"
                  (nzPageSizeChange)="onPageSizeChange($event)"
                  [nzPageIndex]="index"
                  (nzPageIndexChange)="onPageIndexChange($event)"
                  [nzTotal]="response?.totalCount"
                  [nzFrontPagination]="false"
                  nzShowPagination
                  [nzLoading]="isLoading">
          <thead>
          <tr>
            <th nzLeft>{{ 'app.snapshot.name' | i18n }}</th>
            <th nzLeft>Gói Snapshot</th>
            <th nzLeft>{{ 'app.capacity' | i18n }} (GB)</th>
            <th nzLeft>Volume/VM</th>
            <th nzLeft>Loại Snapshot</th>
            <th nzLeft>{{ 'app.service.status' | i18n }}</th>
            <th nzLeft>{{ 'app.users.createDate' | i18n }}</th>
            <th nzLeft>{{ 'app.action-history.operation' | i18n }}</th>
          </tr>
          </thead>
          <tbody>
          <tr *ngFor="let data of fixedTable.data">
            <td><a href="/app-smart-cloud/snapshot/detail/{{data.id}}">{{data.name}}</a></td>
            <td><a href="/app-smart-cloud/snapshot/packages/detail/{{data.snapshotPackageId}}">{{data.packageName}}</a></td>
            <td style="text-align: right">{{data.sizeInGB}}</td>
            <td>{{data.fromRootVolume == true ? data.instanceName : data.volumeName}}</td>
            <td>{{data.fromRootVolume == true ? 'Snapshot máy ảo' : 'Snapshot Volume'}}</td>
            <ng-container *ngIf="data.serviceStatus | ServiceStatusPipe as statusModel">
              <td nzBreakWord nzAlign="left" [ngStyle]="{ color: statusModel.color }">{{ statusModel.status }}</td>
            </ng-container>
            <td>{{data.startDate | date : 'dd/MM/yyyy'}}</td>
            <td>
              <img (click)="enableEdit(data)" src="assets/imgs/edit-2.svg" alt="" nzTooltipTitle="{{'app.text.edit' | i18n}}"
                   style="cursor: pointer; width: 20px; height: 20px; margin-bottom: 3px;" />
              <img nz-dropdown [nzDropdownMenu]="opMenu" src="assets/imgs/more1.svg" alt="" style="margin-left: 5px; cursor:pointer;" />
              <nz-dropdown-menu #opMenu="nzDropdownMenu">
              <ul nz-menu>
                <li *ngIf="data.fromRootVolume == false" nz-menu-item (click)="navigateToCreateVolumeVM(data.id,0)">{{ 'volume.notification.request.create' | i18n}}</li>
                <li *ngIf="data.fromRootVolume == true" nz-menu-item (click)="navigateToCreateVolumeVM(data.id,1)">{{ 'app.instances.create1' | i18n}}</li>
                <li nz-menu-item (click)="enableDelete(data)" style="color: red">{{ 'app.delete' | i18n}}</li>
              </ul>
            </nz-dropdown-menu>
            </td>
          </tr>
          </tbody>
        </nz-table>
      </ng-container>
      <ng-container *ngSwitchDefault>
        <result>
          <nz-row>
            <nz-col class="text-center" style="width: 100%">
              <img src="/assets/imgs/init-snapshot.svg" alt="" />
            </nz-col>
          </nz-row>
          <nz-row style="margin-top: 20px">
            <nz-col class="text-center" style="width: 100%">
              <span class="text-intro-title"
                    style="color: #0066b3">Snapshot</span>
            </nz-col>
          </nz-row>
          <nz-row style="margin-top: 20px">
            <nz-col class="text-center" style="width: 100%">
                <span class="text-intro-desc">Giúp người dùng lưu lại trạng thái hiện tại của Volume/VM.<br> Người dùng có thể sử dụng để sao lưu volume trước khi thực hiện 1 thao tác rủi ro đến dữ liệu trên VM.</span>
            </nz-col>
          </nz-row>
          <button style="margin-top: 20px" nz-button [nzType]="'primary'" (click)="navigateToCreate()"
                  nzSize="large">
            <img style="padding-right: 10px; margin-top: -4px" src="assets/imgs/cloud-plus-bold.svg" alt="" />
            Khởi tạo snapshot
          </button>
        </result>
      </ng-container>
    </ng-container>
  </nz-card>
</nz-content>

<nz-modal [(nzVisible)]="isVisibleDelete" nzTitle="Xoá Snapshot" (nzOnCancel)="handleCancel()" [nzStyle]="modalStyle">
  <ng-container *nzModalContent>
    <nz-alert nzBanner
               style="margin-bottom: 10px;"
               nzMessage="Bạn đang thực hiện xoá Snapshot {{dataSelected.name}}. Hành động này không thể được hoàn tác"
               nzShowIcon></nz-alert>
    <div class="text-label" style="margin-bottom: 3px; margin-top: 10px">Đế thực hiện xoá Snapshot, vui lòng nhập tên Snapshot để xác nhận.</div>
    <input nz-input nzSize="large" style="margin-left: -3px" placeholder="{{dataSelected.name}}" [(ngModel)]="nameDelete" (ngModelChange)="confirmNameDelete($event)" type="text" (keydown.enter)="openIpDeleteCf()"/>
  </ng-container>
  <div *nzModalFooter>
    <button nz-button (click)="handleCancel()">
      <img style="padding-right: 10px; margin-top: -4px" src="assets/imgs/cancel.svg" alt="" />{{'app.button.cancel' | i18n}}
    </button>
    <button nz-button nzType="primary" (click)="openIpDelete()" [nzLoading]="loadingDelete" [disabled]="disableDelete">
      <img style="padding-right: 10px; margin-top: -4px" src="assets/imgs/confirm.svg" alt="" />{{'app.button.confirm' | i18n}}
    </button>
  </div>
</nz-modal>

<form nz-form [formGroup]="validateForm" [nzLayout]="'vertical'">
  <!--Chỉnh normal-->
  <nz-modal [(nzVisible)]="isVisibleEdit" nzTitle="Chỉnh sửa Snapshot " [nzStyle]="modalStyle" (nzOnCancel)="handleCancel()">
    <ng-container *nzModalContent>
      <div class="text-label" style="margin-bottom: 10px">
        Tên Snapshot (<span class="text-red">*</span>)<img style="margin-left: 5px;" nz-tooltip="Cho phép chứa ký tự số, chữ, dấu gạch dưới, tối đa 50 ký tự, không chứa ký tự đặc   biệt, không chứa dấu tiếng việt, không chứa dấu cách (ký tự đặc biệt: @,   #, $, %, &, *, +, -, arrow, star, biểu tượng cảm xúc, dấu câu, dấu ngoặc,   hình tròn, hình vuông, hình chữ nhật...)"
                                                           src="assets/imgs/pajamas_question.svg" alt="" />
        <input class="input-custom" nz-input placeholder="{{ 'project.note17' | i18n }}" style="width: 100%"
               formControlName="name">
      </div>
      <div class="text-label mt-5">
        {{ 'volume.table.title.description' | i18n }}
        <textarea maxlength="255" nz-input [nzAutosize]="{ minRows: 3 }" placeholder="{{ 'volume.tooltip.input.description' | i18n }}" style="width: 100%"
                  formControlName="description"></textarea>
      </div>
    </ng-container>
    <div *nzModalFooter>
      <button nz-button (click)="handleCancel()">
        <img style="padding-right: 10px; margin-top: -4px" src="assets/imgs/cancel.svg" alt="" />{{ 'app.button.cancel' | i18n }}
      </button>
      <button [nzLoading]="loadingDelete" nz-button nzType="primary" (click)="updateSnapshot()" [disabled]="validateForm.invalid">
        <img style="padding-right: 10px; margin-top: -4px" src="assets/imgs/confirm.svg" alt="" />{{ 'app.button.confirm' | i18n }}
      </button>
    </div>
  </nz-modal>
</form>

