<page-header
  [breadcrumb]="breadcrumb"
  [action]="action"
  [title]="'app.instances.create' | i18n"
>
  <ng-template #breadcrumb>
    <nz-breadcrumb>
      <nz-breadcrumb-item>
        <a [routerLink]="['/']">{{ 'app.breadcrumb.home' | i18n }}</a>
      </nz-breadcrumb-item>
      <nz-breadcrumb-item>
        <a [routerLink]="['/app-smart-cloud/instances']">{{
          'app.instances' | i18n
        }}</a>
      </nz-breadcrumb-item>
      <nz-breadcrumb-item>{{
        'app.instances.create' | i18n
      }}</nz-breadcrumb-item>
    </nz-breadcrumb>
  </ng-template>
  <ng-template #action>
    <div class="alain-custom-action text-right">
      <share-users-combobox></share-users-combobox>
      <region-select-dropdown
        (valueChanged)="onRegionChange($event)"
      ></region-select-dropdown>
      <project-select-dropdown
        [regionId]="region"
        (userChanged)="onProjectChange($event)"
      ></project-select-dropdown>
    </div>
  </ng-template>
</page-header>

<form nz-form [formGroup]="form" [nzLayout]="'vertical'">
  <nz-card [nzBordered]="false">
    <div style="margin-bottom: 20px">
      <span class="text-card-header">{{ 'app.instances.info' | i18n }}</span>
    </div>
    <nz-row nzGutter="16">
      <nz-col nzSpan="24">
        <nz-form-item>
          <nz-form-label nzFor="name"
            >{{ 'app.instances.name' | i18n }} (<span class="text-red">*</span>)</nz-form-label
          >

          <nz-form-control nzDisableAutoTips [nzErrorTip]="nameErrorTpl">
            <nz-row>
              <nz-col nzSpan="12">
                <input
                  class="input-custom"
                  nz-input
                  formControlName="name"
                  [(ngModel)]="instanceCreate.serviceName"
                  id="name"
                  [placeholder]="'app.input.name' | i18n"
                  [maxlength]="50"
                  (change)="
                    instanceCreate.serviceName =
                      instanceCreate.serviceName.trim()
                  "
                />
              </nz-col>
              <nz-col style="display: flex; align-items: center" nzSpan="12">
                <nz-switch
                  style="margin-left: 20px"
                  nzSize="small"
                  [(ngModel)]="isSnapshot"
                  [ngModelOptions]="{ standalone: true }"
                  (ngModelChange)="initSnapshot()"
                ></nz-switch>
                <label nzFor="name" style="text-align: right; padding-left: 1%"
                  >Tạo từ Snapshot</label
                >
              </nz-col>
            </nz-row>
            <ng-template #nameErrorTpl let-control>
              <ng-container *ngIf="control.hasError('required')"
                >Vui lòng nhập thông tin</ng-container
              >
              <ng-container *ngIf="control.hasError('pattern')"
                >Không bao gồm dấu tiếng Việt, dấu cách, ký tự đặc biệt (trừ
                _)</ng-container
              >
            </ng-template>
          </nz-form-control>
        </nz-form-item>
      </nz-col>
    </nz-row>
    <div *ngIf="isSnapshot">
      <nz-col nzLg="24" nzMd="12" nzSm="24">
        <nz-form-item>
          <nz-form-label nzFor="name">Chọn Snapshot</nz-form-label>
          <nz-form-control nzErrorTip="Vui lòng Chọn Snapshot">
            <nz-select
              [nzPlaceHolder]="'--Chọn Snapshot--'"
              [nzShowSearch]="true"
              [(ngModel)]="selectedSnapshot"
              [ngModelOptions]="{ standalone: true }"
              (ngModelChange)="onChangeSnapshot($event)"
              nzSize="large"
            >
              <nz-option
                *ngFor="let i of listSnapshot"
                [nzLabel]="i.name"
                [nzValue]="i.id"
              />
            </nz-select>
          </nz-form-control>
        </nz-form-item>
      </nz-col>
    </div>
    <div style="margin-left: -10px" *ngIf="!isSnapshot">
      <nz-form-label style="margin-left: 10px"
        >{{ 'app.instances.OS' | i18n }} (<span class="text-red">*</span>)</nz-form-label
      >
      <ngu-carousel
        #myCarouselImage
        [inputs]="carouselTileConfig"
        [dataSource]="listImageTypes"
      >
        <ngu-tile
          *nguCarouselDef="let data; index as i; let ani = animate"
          [@slider]="ani"
        >
          <div
            class="images-body"
            [id]="'images_' + data.id"
            [ngClass]="{
              'images-body-active': data.id === selectedImageTypeId,
              bgGray: !data.id === selectedImageTypeId
            }"
          >
            <nz-row>
              <nz-col class="text-center" style="width: 100%">
                <img
                  *ngIf="data.name == 'Linux'"
                  src="assets/imgs/ubuntu.png"
                  alt=""
                />
                <img
                  *ngIf="data.name == 'Windows'"
                  src="assets/imgs/window.png"
                  alt=""
                />
              </nz-col>
            </nz-row>
            <nz-row>
              <nz-col class="text-center" style="width: 100%">
                <div style="margin-top: 15px; margin-bottom: 15px">
                  <nz-select
                    nzShowSearch
                    [id]="'hdh_' + data.id"
                    [(ngModel)]="listSelectedImage[i]"
                    (ngModelChange)="onInputHDH($event, i, data.id)"
                    nzPlaceHolder="Chọn phiên bản"
                    [ngModelOptions]="{ standalone: true }"
                    style="text-align: center; width: 150px"
                  >
                    <nz-option
                      *ngFor="let p of listOfImageByImageType.get(data.id)"
                      [nzValue]="p.id"
                      [nzLabel]="p.name"
                    ></nz-option>
                  </nz-select>
                </div>
              </nz-col>
            </nz-row>
          </div>
        </ngu-tile>

        <ul class="myPoint" NguCarouselPoint>
          <li
            *ngFor="let i of myCarouselImage.pointNumbers"
            [class.active]="i === myCarouselImage.activePoint"
            (click)="myCarouselImage.moveTo(i)"
          ></li>
        </ul>
      </ngu-carousel>
    </div>

    <br />
    <nz-row nzGutter="16">
      <nz-form-label
        >Chọn loại Volume (<span class="text-red">*</span>)</nz-form-label
      >
    </nz-row>
    <nz-radio-group
      style="width: 100%; display: inline-flex"
      name="selectedHDDorSSD"
    >
      <nz-row
        [nzGutter]="{ xs: 24, sm: 24, md: 24, lg: 24 }"
        style="margin-top: 10px"
        ><nz-col [nzLg]="12" [nzMd]="24" [nzSm]="24" [nzXl]="12" [nzXs]="24">
          <nz-card
            style="border-radius: 4px"
            [nzAlign]="'middle'"
            [ngStyle]="{
                    border: activeBlockHDD
                  ? '1px solid #0066B3'
                  : '1px solid #DADADA',
                  height: cardHeight,
                }"
          >
            <nz-row nzGutter="16">
              <nz-col nzSpan="20">
                <nz-card-meta
                  [nzAvatar]="nzAvatarselectedHDDorSSD1"
                  [nzTitle]="nzTitleselectedHDDorSSD1"
                  [nzDescription]="nzDescriptionselectedHDDorSSD1"
                >
                  <ng-template #nzAvatarselectedHDDorSSD1>
                    <label
                      nz-radio
                      [ngModel]="activeBlockHDD"
                      [ngModelOptions]="{ standalone: true }"
                      (click)="initHDD()"
                    ></label>
                  </ng-template>
                  <ng-template #nzTitleselectedHDDorSSD1>
                    <b>HDD</b>
                  </ng-template>
                  <ng-template #nzDescriptionselectedHDDorSSD1>
                    <ellipsis class="text-custom">
                      Lựa chọn tốt hơn nếu bạn đang đối phó với các bản sao lưu
                      dữ liệu, lưu trữ dữ liệu hoặc khối lượng công việc chuyên
                      sâu thông lượng
                    </ellipsis>
                  </ng-template>
                </nz-card-meta></nz-col
              >
              <nz-col
                style="display: flex; align-items: center; margin-top: -24px"
                [ngStyle]="{
                      height: cardHeight,
                    }"
                nzSpan="4"
              >
                <img
                  [src]="
                    activeBlockHDD
                      ? 'assets/imgs/hdd-svgrepo-com-active.svg'
                      : 'assets/imgs/hdd-svgrepo-com.svg'
                  "
                  alt=""
                />
              </nz-col>
            </nz-row>
          </nz-card>
        </nz-col>
        <nz-col [nzLg]="12" [nzMd]="24" [nzSm]="24" [nzXl]="12" [nzXs]="24">
          <nz-card
            style="border-radius: 4px"
            [nzAlign]="'middle'"
            [ngStyle]="{
                  border: activeBlockSSD
                  ? '1px solid #0066B3'
                  : '1px solid #DADADA',
                  height: cardHeight,
                }"
          >
            <nz-row nzGutter="16">
              <nz-col nzSpan="20"
                ><nz-card-meta
                  [nzAvatar]="nzAvatarselectedHDDorSSD2"
                  [nzTitle]="nzTitleselectedHDDorSSD2"
                  [nzDescription]="nzDescriptionselectedHDDorSSD2"
                >
                  <ng-template #nzAvatarselectedHDDorSSD2>
                    <label
                      nz-radio
                      [ngModel]="activeBlockSSD"
                      [ngModelOptions]="{ standalone: true }"
                      (click)="initSSD()"
                    ></label>
                  </ng-template>
                  <ng-template #nzTitleselectedHDDorSSD2>
                    <b>SSD</b>
                  </ng-template>
                  <ng-template #nzDescriptionselectedHDDorSSD2>
                    <ellipsis class="text-custom"
                      >Lựa chọn tốt hơn cho khối lượng công việc phân tích dữ
                      liệu hoặc chơi game
                    </ellipsis>
                  </ng-template>
                </nz-card-meta>
              </nz-col>
              <nz-col
                style="display: flex; align-items: center; margin-top: -24px"
                [ngStyle]="{
                        height: cardHeight,
                      }"
                nzSpan="4"
              >
                <img
                  [src]="
                    activeBlockSSD
                      ? 'assets/imgs/ssd-svgrepo-com-active.svg'
                      : 'assets/imgs/ssd-svgrepo-com.svg'
                  "
                  alt=""
                />
              </nz-col>
            </nz-row>
          </nz-card> </nz-col
      ></nz-row>
    </nz-radio-group>
    <nz-row nzGutter="24">
      <nz-col nzLg="8" nzMd="8" nzSm="24">
        <nz-form-label style="margin-left: -12px"
          >Dung lượng (<span class="text-red">*</span>) - GB</nz-form-label
        >
        <nz-row>
          <nz-col nzSpan="18">
            <nz-slider
              [nzMin]="1"
              [nzMax]="remainingVolume"
              [(ngModel)]="instanceCreate.volumeSize"
              [ngModelOptions]="{ standalone: true }"
            ></nz-slider>
          </nz-col>
          <div nzSpan="6">
            <nz-input-number
              [nzMin]="1"
              [nzMax]="remainingVolume"
              [(ngModel)]="instanceCreate.volumeSize"
              (keydown)="onKeyDown($event)"
              [ngModelOptions]="{ standalone: true }"
            ></nz-input-number>
          </div>
        </nz-row>
      </nz-col>
      <nz-col nzLg="8" nzMd="8" nzSm="24">
        <nz-form-label style="margin-left: -12px"
          >RAM (<span class="text-red">*</span>) - GB</nz-form-label
        >
        <nz-row>
          <nz-col nzSpan="18">
            <nz-slider
              [nzMin]="1"
              [nzMax]="remainingRAM"
              [(ngModel)]="instanceCreate.ram"
              [ngModelOptions]="{ standalone: true }"
            ></nz-slider>
          </nz-col>
          <div nzSpan="6">
            <nz-input-number
              [nzMin]="1"
              [nzMax]="remainingRAM"
              [(ngModel)]="instanceCreate.ram"
              (keydown)="onKeyDown($event)"
              [ngModelOptions]="{ standalone: true }"
            ></nz-input-number>
          </div>
        </nz-row>
      </nz-col>
      <nz-col nzLg="8" nzMd="8" nzSm="24">
        <nz-form-label style="margin-left: -12px"
          >CPU (<span class="text-red">*</span>) - vCPU</nz-form-label
        >
        <nz-row>
          <nz-col nzSpan="18">
            <nz-slider
              [nzMin]="1"
              [nzMax]="remainingVCPU"
              [(ngModel)]="instanceCreate.cpu"
              [ngModelOptions]="{ standalone: true }"
            ></nz-slider>
          </nz-col>
          <div nzSpan="6">
            <nz-input-number
              [nzMin]="1"
              [nzMax]="remainingVCPU"
              [(ngModel)]="instanceCreate.cpu"
              (keydown)="onKeyDown($event)"
              [ngModelOptions]="{ standalone: true }"
            ></nz-input-number>
          </div>
        </nz-row>
      </nz-col>
    </nz-row>
    <nz-row style="margin-top: 20px; margin-bottom: 20px"
      ><div style="margin-right: 20px">IOPS: 200</div>
      <div>
        <label
          nz-checkbox
          [(ngModel)]="instanceCreate.encryption"
          [ngModelOptions]="{ standalone: true }"
          >Mã hóa Volume</label
        >
      </div></nz-row
    >
    <nz-row nzGutter="16">
      <nz-col nzLg="12" nzMd="12" nzSm="24">
        <nz-form-item>
          <nz-form-label>Chọn IP Public</nz-form-label>
          <nz-form-control>
            <nz-select
              [nzShowSearch]="true"
              [(ngModel)]="ipPublicValue"
              (ngModelChange)="onChangeIpPublic()"
              [ngModelOptions]="{ standalone: true }"
              nzSize="large"
            >
              <nz-option nzLabel="Không sử dụng" [nzValue]="0" />
              <nz-option
                *ngFor="let i of listIPPublic"
                [nzLabel]="i.ipAddress || i.networkId"
                [nzValue]="i.id"
              />
            </nz-select>
          </nz-form-control>
          <nz-form-label style="margin-top: 24px"
            >Chọn VLAN gắn vào máy ảo (<span class="text-red">*</span
            >)</nz-form-label
          >
          <nz-form-control nzErrorTip="Chọn VLAN *">
            <nz-select
              [nzShowSearch]="true"
              [(ngModel)]="vlanNetwork"
              (ngModelChange)="getListPort()"
              [ngModelOptions]="{ standalone: true }"
              nzSize="large"
            >
              <nz-option
                *ngFor="let i of listVlanNetwork"
                [nzLabel]="i.name"
                [nzValue]="i.cloudId"
              />
            </nz-select>
          </nz-form-control>
        </nz-form-item>
      </nz-col>
      <nz-col nzLg="12" nzMd="12" nzSm="24">
        <nz-form-item>
          <nz-form-label>Chọn Security Group</nz-form-label>
          <nz-form-control>
            <nz-select
              nzMode="multiple"
              nzPlaceHolder="Chọn Security Group"
              [ngModelOptions]="{ standalone: true }"
              [(ngModel)]="selectedSecurityGroup"
              [nzServerSearch]="true"
              nzSize="large"
            >
              <nz-option
                *ngFor="let i of listSecurityGroup"
                [nzLabel]="i.name"
                [nzValue]="i.name"
              />
            </nz-select>
          </nz-form-control>
        </nz-form-item>
        <div>
          <nz-alert
            nzType="warning"
            [nzDescription]="nzDescriptionWarning3"
            nzShowIcon
          ></nz-alert>
          <ng-template #nzDescriptionWarning3>
            <div>
              Để thiết lập các cơ chế truy cập vào máy ảo, Quý khách cần cấu
              hình Security Group <br />
              trong mục <u><a>{{ 'app.alert.access.security' | i18n }}</a></u>
            </div>
          </ng-template>
        </div>
      </nz-col>
    </nz-row>
    <nz-row nzGutter="16">
      <nz-col nzLg="12" nzMd="12" nzSm="24">
        <nz-form-item
          ><nz-form-label
            >Chọn Port (<span class="text-red">*</span>)</nz-form-label
          >
          <nz-form-control>
            <nz-select
              [nzShowSearch]="true"
              [(ngModel)]="port"
              [ngModelOptions]="{ standalone: true }"
              nzSize="large"
            >
              <nz-option
                *ngFor="let i of listPort"
                [nzLabel]="i.macAddress"
                [nzValue]="i.macAddress"
              />
            </nz-select>
          </nz-form-control>
        </nz-form-item>
      </nz-col>
      <nz-col
        style="display: flex; align-items: center"
        nzLg="12"
        nzMd="12"
        nzSm="24"
      >
        <label
          nz-checkbox
          [(ngModel)]="isUseLAN"
          [ngModelOptions]="{ standalone: true }"
          >Sử dụng mạng LAN</label
        >
      </nz-col>
    </nz-row>
    <nz-row>
      <nz-form-label nzFor="name"
        >Chọn phương thức truy cập máy ảo (<span class="text-red">*</span
        >)</nz-form-label
      >
    </nz-row>
    <nz-row nzGutter="16">
      <nz-radio-group
        style="width: 100%; display: inline-flex"
        name="selectedPasswordOrSSHkey"
      >
        <nz-col nzXs="24" nzMd="12">
          <nz-card
            style="border-radius: 4px"
            [ngStyle]="{
              border: activeBlockPassword
                ? '1px solid #0066B3'
                : '1px solid #DADADA'
            }"
          >
            <nz-card-meta
              [nzAvatar]="nzAvatarselectedPasswordOrSSHkey1"
              [nzTitle]="nzTitleselectedPasswordOrSSHkey1"
              [nzDescription]="nzDescriptionselectedPasswordOrSSHkey1"
            >
              <ng-template #nzAvatarselectedPasswordOrSSHkey1>
                <label
                  nz-radio
                  [ngModel]="activeBlockPassword"
                  [ngModelOptions]="{ standalone: true }"
                  (click)="initPassword()"
                ></label>
              </ng-template>
              <ng-template #nzTitleselectedPasswordOrSSHkey1>
                <b>Mật khẩu</b>
              </ng-template>
              <ng-template #nzDescriptionselectedPasswordOrSSHkey1>
                <ellipsis class="text-custom">
                  Thuận tiện cho người dùng</ellipsis
                >
              </ng-template>
            </nz-card-meta>
          </nz-card>
        </nz-col>
        <nz-col nzXs="24" nzMd="12">
          <nz-card
            style="border-radius: 4px"
            [ngStyle]="{
              border: activeBlockSSHKey
                ? '1px solid #0066B3'
                : '1px solid #DADADA'
            }"
          >
            <nz-card-meta
              [nzAvatar]="nzAvatarselectedPasswordOrSSHkey2"
              [nzTitle]="nzTitleselectedPasswordOrSSHkey2"
              [nzDescription]="nzDescriptionselectedPasswordOrSSHkey2"
            >
              <ng-template #nzAvatarselectedPasswordOrSSHkey2>
                <label
                  nz-radio
                  [ngModel]="activeBlockSSHKey"
                  [ngModelOptions]="{ standalone: true }"
                  (click)="initSSHkey()"
                ></label>
              </ng-template>
              <ng-template #nzTitleselectedPasswordOrSSHkey2>
                <b>SSH key</b>
              </ng-template>
              <ng-template #nzDescriptionselectedPasswordOrSSHkey2>
                <ellipsis class="text-custom">
                  Tăng tính bảo mật khi đăng nhập</ellipsis
                >
              </ng-template>
            </nz-card-meta>
          </nz-card>
        </nz-col>
      </nz-radio-group>
      <div *ngIf="activeBlockPassword" style="width: 100%">
        <nz-col nzLg="24" nzMd="12" nzSm="24">
          <nz-form-item>
            <nz-form-label nzFor="name"
              >Mật khẩu truy cập máy ảo (<span class="text-red">*</span
              >)</nz-form-label
            >
            <nz-form-control
              nzErrorTip="Vui lòng nhập mật khẩu truy cập máy ảo"
            >
              <nz-input-group [nzSuffix]="suffixTemplate" style="width: 100%">
                <input
                  class="input-custom"
                  [type]="passwordVisible ? 'text' : 'password'"
                  nz-input
                  placeholder="Nhập mật khẩu"
                  [(ngModel)]="password"
                  [ngModelOptions]="{ standalone: true }"
                />
              </nz-input-group>
              <ng-template #suffixTemplate>
                <img
                  style="margin-top: -4px"
                  [src]="
                    passwordVisible
                      ? 'assets/imgs/eye-close.svg'
                      : 'assets/imgs/eye1.svg'
                  "
                  alt=""
                  (click)="passwordVisible = !passwordVisible"
                />
              </ng-template>
            </nz-form-control>
          </nz-form-item>
        </nz-col>

        <nz-col nzLg="24" nzMd="12" nzSm="24">
          <nz-alert
            nzType="warning"
            [nzDescription]="nzDescriptionWarning06"
            nzShowIcon
          ></nz-alert>
          <ng-template #nzDescriptionWarning06>
            <div>
              Quy tắc đặt mật khẩu: Độ dài của một mật khẩu được sử dụng trực
              tuyến cần phải chứa tối thiểu là 12 ký tự, sử dụng hỗn hợp bao gồm
              các chữ số, chữ hoa, chữ thường và ký hiệu đặc biệt.
            </div>
          </ng-template>
        </nz-col>
      </div>
      <div *ngIf="activeBlockSSHKey" style="width: 100%">
        <nz-col nzLg="24" nzMd="12" nzSm="24">
          <nz-form-item>
            <nz-form-label
              >Chọn SSH key (<span class="text-red">*</span>)</nz-form-label
            >
            <nz-form-control nzErrorTip="Chọn  *">
              <nz-select
                [nzPlaceHolder]="'--Chọn SSH key--'"
                [nzShowSearch]="true"
                [ngModelOptions]="{ standalone: true }"
                [(ngModel)]="selectedSSHKeyName"
                (ngModelChange)="onSSHKeyChange($event)"
                nzSize="large"
              >
                <nz-option
                  *ngFor="let i of listSSHKey"
                  [nzLabel]="i.displayName"
                  [nzValue]="i.displayName"
                />
              </nz-select>
            </nz-form-control>
          </nz-form-item>
        </nz-col>

        <nz-col nzLg="24" nzMd="12" nzSm="24">
          <nz-alert
            nzType="warning"
            [nzDescription]="nzDescriptionWarning07"
            nzShowIcon
          ></nz-alert>
          <ng-template #nzDescriptionWarning07>
            <div>
              Chúng tôi khuyến cáo sử dụng SSH Key để đảm an toàn bảo mật cho
              máy chủ của quý khách. Thông tin hướng dẫn sử dụng về SSH key cho
              máy chủ có thể xem tại đây.
              <br />
              Mật khẩu đăng nhập vào máy chủ sẽ được tạo tự động và gửi vào
              email của quý khách khi máy chủ được tạo thành công
            </div>
          </ng-template>
        </nz-col>
      </div>
    </nz-row>
  </nz-card>

  <div style="float: right; padding-top: 1%">
    <button nz-button nzType="default" (click)="cancel()">
      <img
        style="padding-right: 10px; margin-top: -4px"
        src="assets/imgs/cancel.svg"
        alt=""
      />{{ 'app.button.cancel' | i18n }}
    </button>
    <button
      nz-button
      nzType="primary"
      [disabled]="form.invalid"
      (click)="showModalCreate()"
    >
      Khởi tạo
    </button>
  </div>
</form>

<nz-modal
  [(nzVisible)]="isVisibleCreate"
  nzTitle="Xác nhận khởi tạo máy ảo"
  (nzOnCancel)="handleCancelCreate()"
>
  <div *nzModalContent>
    Quý khách chắn chắn muốn thực hiện khởi tạo máy ảo không?<br />• Tên máy ảo:
    {{ instanceCreate.serviceName }}<br />• Hệ điều hành: {{ nameImage }}<br />•
    Gói cấu hình: {{ instanceCreate.cpu }} vCPU / {{ instanceCreate.ram }}GB RAM
    / {{ instanceCreate.volumeSize }}GB {{ instanceCreate.vmType | uppercase }}
  </div>
  <div *nzModalFooter>
    <button nz-button (click)="handleCancelCreate()">
      <img
        style="padding-right: 10px; margin-top: -4px"
        src="assets/imgs/cancel.svg"
        alt=""
      />{{ 'app.button.cancel' | i18n }}
    </button>
    <button nz-button nzType="primary" (click)="handleOkCreate()">
      <img
        style="padding-right: 10px; margin-top: -4px"
        src="assets/imgs/confirm.svg"
        alt=""
      />X{{ 'app.button.confirm' | i18n }}
    </button>
  </div>
</nz-modal>
