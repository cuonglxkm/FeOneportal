<page-header
  [breadcrumb]="breadcrumb"
  [action]="action"
  [title]="'Danh sách máy ảo'"
>
  <ng-template #breadcrumb>
    <nz-breadcrumb>
      <nz-breadcrumb-item
        ><a [routerLink]="['/']">Trang chủ</a></nz-breadcrumb-item
      >
      <nz-breadcrumb-item> Quản lý máy ảo </nz-breadcrumb-item>
    </nz-breadcrumb>
  </ng-template>
  <ng-template #action>
    <div class="alain-custom-action text-right">
      <region-select-dropdown
        (valueChanged)="onRegionChange($event)"
      ></region-select-dropdown>
      <project-select-dropdown
        [regionId]="region"
        (valueChanged)="onProjectChange($event)"
        (userChanged)="onProjectChange($event)"
      ></project-select-dropdown>
    </div>
  </ng-template>
</page-header>

<nz-card style="border-radius: 4px" *ngIf="!activeCreate">
  <div style="margin-bottom: 20px" nz-row [nzGutter]="24">
    <div
      nz-col
      [nzLg]="12"
      [nzMd]="12"
      [nzSm]="24"
      [nzXl]="12"
      [nzXs]="24"
      [nzXXl]="12"
    >
      <nz-select
        style="width: 20%"
        [(ngModel)]="searchParam.status"
        [ngModelOptions]="{ standalone: true }"
        [nzPlaceHolder]="'Trạng thái máy ảo'"
        [nzShowSearch]="false"
        (ngModelChange)="doSearch()"
        nzSize="large"
      >
        <nz-option
          *ngFor="let i of filterStatus"
          [nzLabel]="i.text"
          [nzValue]="i.value"
        />
      </nz-select>
      <nz-input-group
        style="margin-left: 8px; width: 50%; border-radius: 8px"
        [nzPrefix]="prefixIconSearch"
        nzSize="large"
      >
        <input
          name="name"
          nz-input
          placeholder="Tìm kiếm tên, thời gian tạo ..."
          [(ngModel)]="searchParam.name"
          (keyup.enter)="doSearch()"
        />
      </nz-input-group>
      <ng-template #prefixIconSearch>
        <img
          src="assets/imgs/search.svg"
          alt=""
          style="cursor: pointer"
          nz-tooltip="Tìm kiếm"
          (click)="doSearch()"
        />
      </ng-template>
    </div>
    <div
      class="text-right p-0 m-b-0"
      nz-col
      [nzLg]="12"
      [nzMd]="12"
      [nzSm]="24"
      [nzXl]="12"
      [nzXs]="24"
      [nzXXl]="12"
    >
      <button
        nz-button
        nzType="primary"
        (click)="navigateToCreate()"
        nzSize="large"
      >
        <img
          style="padding-right: 10px; margin-top: -4px"
          src="assets/imgs/add-circle.svg"
          alt=""
        />
        Tạo mới máy ảo
      </button>
    </div>
  </div>
  <nz-table
    #ajaxTable3
    nzShowSizeChanger
    [nzFrontPagination]="false"
    [nzData]="dataList"
    [nzLoading]="loading"
    [nzTotal]="total"
    [(nzPageIndex)]="pageIndex"
    [(nzPageSize)]="pageSize"
    (nzPageIndexChange)="getDataList()"
    (nzPageSizeChange)="getDataList()"
    [nzVirtualItemSize]="54"
    [nzScroll]="{ x: '100%', y: '55vh' }"
  >
    <thead>
      <tr>
        <th nzLeft>Tên máy ảo</th>
        <th>Gói cấu hình</th>
        <th>Trạng thái máy ảo</th>
        <th>Trạng thái tác vụ</th>
        <th>IP LAN</th>
        <th>IP Public</th>
        <th nzRight>Thao tác</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let data of ajaxTable3.data">
        <td nzLeft>
          <a
            nz-tooltip
            nzTooltipTitle="Xem chi tiết"
            nzTooltipPlacement="bottom"
            [routerLink]="
              '/app-smart-cloud/instances/instances-detail/' + data.id
            "
            >{{ data.name }}</a
          >
        </td>
        <td nzBreakWord>
          {{ data.flavorName }}
          <!-- flavorId với flavorCloudId(mã dưới hệ thống openstack) ạ -->
        </td>
        <td nzBreakWord>
          <div style="color: #0066b3">
            {{ getStatus(data.status) }}
          </div>
        </td>
        <td nzBreakWord>{{ data.taskState }}</td>
        <td nzBreakWord>{{ data.ipPrivate }}</td>
        <td nzBreakWord>{{ data.ipPublic }}</td>
        <td nzRight>
          <img
            src="assets/imgs/create-backup.svg"
            alt=""
            (click)="navigateToCreateBackup(data.id)"
            style="cursor: pointer; margin-right: 16px"
            nz-tooltip="Tạo Backup"
          />
          <img
            src="assets/imgs/edit-2.svg"
            alt=""
            (click)="navigateToEdit(data.id)"
            style="cursor: pointer; margin-right: 16px"
            nz-tooltip="Chỉnh sửa"
          />
          <img
            src="assets/imgs/calendar-tick.svg"
            alt=""
            style="cursor: pointer; margin-right: 16px"
            nz-tooltip="Tạo lịch Backup"
          />
          <img
            nz-dropdown
            [nzDropdownMenu]="opMenu"
            src="assets/imgs/more1.svg"
            alt=""
          />
          <nz-dropdown-menu #opMenu="nzDropdownMenu">
            <ul nz-menu>
              <li nz-menu-item>Chỉnh sửa Security Group</li>
              <li nz-menu-item (click)="showHandleGanVLAN()">Gắn vào VLAN</li>
              <li nz-menu-item (click)="showHandleGoKhoiVLAN()">
                Gỡ khỏi VLAN
              </li>
              <li
                *ngIf="data.taskState != 'SHUTOFF'"
                nz-menu-item
                (click)="restartInstance(data.id)"
              >
                Khởi động lại
              </li>
              <li
                *ngIf="data.taskState != 'SHUTOFF'"
                nz-menu-item
                (click)="shutdownInstance(data.id)"
              >
                Tắt máy ảo
              </li>
              <li
                *ngIf="data.taskState == 'SHUTOFF'"
                nz-menu-item
                (click)="startInstance(data.id)"
              >
                Bật máy ảo
              </li>
              <li nz-menu-item (click)="rescueInstance(data.id)">RESCUE</li>
            </ul>
          </nz-dropdown-menu>
        </td>
      </tr>
    </tbody>
  </nz-table>
</nz-card>

<div *ngIf="!loading && activeCreate">
  <nz-card>
    <result>
      <nz-row>
        <nz-col class="text-center" style="width: 100%">
          <img src="assets/imgs/blank_vm.svg" alt="" />
        </nz-col>
      </nz-row>
      <nz-row style="margin-top: 20px">
        <nz-col class="text-center" style="width: 100%"
          ><span class="text-intro-title" style="color: #0066b3">
            Máy chủ ảo<br />Dễ dàng khởi tạo và triển khai dịch vụ</span
          ></nz-col
        >
      </nz-row>
      <nz-row style="margin-top: 20px">
        <nz-col class="text-center" style="width: 100%"
          ><span class="text-intro-desc">
            Dịch vụ cung cấp hệ thống máy chủ ảo an toàn, tin cậy được thiết kế
            tập trung cho khả năng mở rộng dễ dàng.<br />
            Người dùng có thể dễ dàng tạo, cấu hình compute instance với số
            lượng thao tác đơn giản nhất.</span
          ></nz-col
        >
      </nz-row>
      <button
        style="margin-top: 20px"
        nz-button
        [nzType]="'primary'"
        (click)="navigateToCreate()"
        nzSize="large"
      >
        <img
          style="padding-right: 10px; margin-top: -4px"
          src="assets/imgs/cloud-plus-bold.svg"
          alt=""
        />
        Tạo mới máy ảo
      </button>
    </result>
  </nz-card>
</div>

<nz-modal
  [(nzVisible)]="isVisibleGanVLAN"
  nzTitle="Gắn VLAN"
  (nzOnCancel)="handleCancelGanVLAN()"
>
  <ng-container *nzModalContent>
    <span class="text-label">Danh sách VLAN</span>
    <nz-form-control>
      <nz-select
        [nzPlaceHolder]="'-- Chọn VLAN --'"
        [nzShowSearch]="true"
        nzSize="large"
      >
        <nz-option
          *ngFor="let i of listVLAN"
          [nzLabel]="i.text"
          [nzValue]="i.id"
        />
      </nz-select>
    </nz-form-control>
    <div style="margin-top: 10px; margin-bottom: 5px">
      <a (click)="clickIPAddress()"
        ><span style="color: #0066b3">Nhập IP Address</span>
        <img
          style="padding-right: 10px"
          [src]="
            isExpand
              ? 'assets/imgs/arrow-up.svg'
              : 'assets/imgs/arrow-down-b3.svg'
          "
          alt=""
        />
      </a>
    </div>
    <div *ngIf="isExpand">
      <span class="text-label">Danh sách Subnet</span>
      <nz-form-control style="margin-bottom: 10px" class="text-right">
        <nz-select
          [nzPlaceHolder]="'-- Chọn Subnet --'"
          [nzShowSearch]="true"
          nzSize="large"
        >
          <nz-option
            *ngFor="let i of listSubnet"
            [nzLabel]="i.text"
            [nzValue]="i.id"
          />
        </nz-select>
      </nz-form-control>
      <span class="text-label">Địa chỉ IP</span>
      <nz-form-control style="margin-bottom: 10px" class="text-right">
        <nz-select
          [nzPlaceHolder]="'-- Chọn địa chỉ IP --'"
          [nzShowSearch]="true"
          nzSize="large"
        >
          <nz-option
            *ngFor="let i of listIPAddress"
            [nzLabel]="i.text"
            [nzValue]="i.id"
          />
        </nz-select>
      </nz-form-control>
    </div>

    <nz-alert
      nzType="warning"
      [nzDescription]="customTemplateDescriptionGanVLAN"
      nzShowIcon
    ></nz-alert>
    <ng-template #customTemplateDescriptionGanVLAN>
      <div>
        Trong trường hợp 1 Network của quý khách có nhiều Subnet, quý khách cần
        lựa chọn Subnet và điền IP muốn gán cho máy ảo. Khi quý khách nhạp IP
        vui lòng chọn IP chưa được sử dụng bởi máy ảo nào và IP này thuộc dải IP
        được cấu hình trong Subnet tương ứng
      </div>
    </ng-template>
  </ng-container>
  <div *nzModalFooter>
    <button nz-button (click)="handleCancelGanVLAN()">
      <img
        style="padding-right: 10px; margin-top: -4px"
        src="assets/imgs/cancel.svg"
        alt=""
      />Hủy
    </button>
    <button nz-button nzType="primary" (click)="handleOkGanVLAN()">
      <img
        style="padding-right: 10px; margin-top: -4px"
        src="assets/imgs/confirm.svg"
        alt=""
      />
      Gắn
    </button>
  </div>
</nz-modal>

<nz-modal
  [(nzVisible)]="isVisibleGoKhoiVLAN"
  nzTitle="Gỡ khỏi VLAN"
  (nzOnCancel)="handleCancelGoKhoiVLAN()"
>
  <ng-container *nzModalContent>
    <nz-alert
      style="margin-bottom: 20px"
      nzType="warning"
      [nzDescription]="customTemplateDescriptionGoVLAN"
      nzShowIcon
    ></nz-alert>
    <ng-template #customTemplateDescriptionGoVLAN>
      <div>
        Mỗi kết nối từ máy ảo với VLAN tương ứng với 1 IP được cấp, lựa chọn IP
        từ danh sách dưới đây để thực hiện gỡ kết nối máy ảo khỏi VLAN
      </div>
    </ng-template>
    <span class="text-label">Danh sách IP trên VLAN</span>
    <nz-form-control>
      <nz-select
        [nzPlaceHolder]="'-- Chọn địa chỉ IP --'"
        [nzShowSearch]="true"
        nzSize="large"
      >
        <nz-option
          *ngFor="let i of listIPAddressOnVLAN"
          [nzLabel]="i.text"
          [nzValue]="i.id"
        />
      </nz-select>
    </nz-form-control>
  </ng-container>
  <div *nzModalFooter>
    <button nz-button (click)="handleCancelGoKhoiVLAN()">
      <img
        style="padding-right: 10px; margin-top: -4px"
        src="assets/imgs/cancel.svg"
        alt=""
      />Hủy
    </button>
    <button nz-button nzType="primary" (click)="handleOkGoKhoiVLAN()">
      <img
        style="padding-right: 10px; margin-top: -4px"
        src="assets/imgs/confirm.svg"
        alt=""
      />
      Gỡ
    </button>
  </div>
</nz-modal>
