<!--Head section-->
<!-- <app-page-header [pageHeaderInfo]="pageHeaderInfo"></app-page-header> -->

<page-header
  [autoBreadcrumb]="false"
  [autoTitle]="false"
  style="background: white"
>
  <nz-breadcrumb style="float: left">
    <nz-breadcrumb-item>Home</nz-breadcrumb-item>
    <nz-breadcrumb-item> Quản lý máy ảo </nz-breadcrumb-item>
  </nz-breadcrumb>
  <div class="text-right non-pointer">
    <region-select-dropdown
      (valueChanged)="onRegionChange($event)"
    ></region-select-dropdown>
    <project-select-dropdown
      [regionId]="region"
      (valueChanged)="onProjectChange($event)"
    ></project-select-dropdown>
  </div>
  <div><h2>Danh sách máy ảo</h2></div>
  <form nz-form *ngIf="isSearch">
    <div
      style="margin-bottom: -10px"
      nz-row
      [nzGutter]="{ xs: 8, sm: 16, md: 24, lg: 24 }"
    >
      <div
        nz-col
        [nzLg]="7"
        [nzMd]="7"
        [nzSm]="24"
        [nzXl]="7"
        [nzXs]="24"
        [nzXXl]="7"
      >
        <nz-form-item>
          <nz-form-label [nzFor]="">Trạng thái máy ảo</nz-form-label>
          <nz-form-control>
            <nz-select
              [ngModel]="searchParam.status"
              [nzPlaceHolder]="'Tất cả trạng thái'"
              [nzShowSearch]="false"
              name="status"
              (ngModelChange)="changeFilterStatus($event)"
            >
              <nz-option
                *ngFor="let i of filterStatus"
                [nzLabel]="i.text"
                [nzValue]="i.value"
              />
            </nz-select>
          </nz-form-control>
        </nz-form-item>
      </div>
      <div
        nz-col
        [nzLg]="11"
        [nzMd]="11"
        [nzSm]="24"
        [nzXl]="11"
        [nzXs]="24"
        [nzXXl]="11"
      >
        <nz-form-item>
          <nz-row style="width: 100%">
            <nz-col style="width: 60%">
              <nz-form-control>
                <input
                  name="name"
                  nz-input
                  placeholder="Tìm kiếm tên máy ảo, gói cấu hình ..."
                  [ngModel]="searchParam.name"
                  (ngModelChange)="changeName($event)"
                />
              </nz-form-control>
            </nz-col>
            <nz-form-control>
              <button nz-button [nzType]="'primary'" (click)="getDataList()">
                <i nz-icon nzType="search"></i>
                Search
              </button>
            </nz-form-control>
          </nz-row>
        </nz-form-item>
      </div>
      <div
        class="text-right p-0 m-b-0"
        nz-col
        [nzLg]="6"
        [nzMd]="6"
        [nzSm]="24"
        [nzXl]="6"
        [nzXs]="24"
        [nzXXl]="6"
      >
        <button
          class="m-r-8"
          class="bg-success border-success"
          nz-button
          nzType="primary"
          (click)="navigateToCreate()"
        >
          <i nz-icon nzType="plus"></i>
          Tạo mới
        </button>
      </div>
    </div>
  </form>
</page-header>

<div class="normal-table-wrap" *ngIf="!activeCreate">
  <nz-table
    #ajaxTable3
    nzShowSizeChanger
    [nzFrontPagination]="false"
    [nzData]="dataList"
    [nzLoading]="loading"
    [nzTotal]="total"
    [(nzPageIndex)]="pageIndex"
    [(nzPageSize)]="pageSize"
    (nzPageIndexChange)="getDataList()"
    (nzPageSizeChange)="getDataList(true)"
  >
    <thead>
      <tr>
        <th>Tên máy ảo</th>
        <th>Gói cấu hình</th>
        <th>Trạng thái máy ảo</th>
        <th>Trạng thái tác vụ</th>
        <th>IP LAN</th>
        <th>IP Public</th>
        <th>Thao tác</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let data of ajaxTable3.data">
        <td class="text-blue" (click)="navigateToDetail(data.id)">
          {{ data.name }}
        </td>
        <td>
          {{ data.flavorName }}
          <!-- flavorId với flavorCloudId(mã dưới hệ thống openstack) ạ -->
        </td>
        <td>
          <div>
            {{ getStatus(data.status) }}
          </div>
        </td>
        <td>{{ data.taskState }}</td>
        <td>{{ data.ipPrivate }}</td>
        <td>{{ data.ipPublic }}</td>
        <td>
          <nz-select
            [nzPlaceHolder]="'Chọn thao tác'"
            ngModel="selectedOptionAction"
            name="selectAction"
            (ngModelChange)="showModal($event, data)"
          >
            <nz-option
              nzValue="1"
              nzLabel="Tạo Backup"
              (click)="navigateToCreateBackup(data.id)"
            ></nz-option>
            <nz-option nzValue="2" nzLabel="Tạo lịch Backup"></nz-option>
            <nz-option
              nzValue="3"
              nzLabel="Chỉnh sửa Security Group"
            ></nz-option>
            <nz-option nzValue="4" nzLabel="Chỉnh sửa"></nz-option>
            <nz-option nzValue="5" nzLabel="Gắn vào VLAN"></nz-option>
            <nz-option nzValue="6" nzLabel="Gỡ khỏi VLAN"></nz-option>
            <nz-option nzValue="7" nzLabel="Khởi động lại"></nz-option>
            <nz-option nzValue="8" nzLabel="Tắt máy ảo"></nz-option>
            <nz-option nzValue="9" nzLabel="RESCUE"></nz-option>
          </nz-select>
        </td>
      </tr>
    </tbody>
  </nz-table>
</div>

<div class="normal-table-wrap" *ngIf="activeCreate && isSearch">
  <nz-table #ajaxTable3 [nzData]="emptyList" [nzLoading]="loading">
    <thead>
      <tr>
        <th>Tên máy ảo</th>
        <th>Gói cấu hình</th>
        <th>Trạng thái máy ảo</th>
        <th>Trạng thái tác vụ</th>
        <th>IP LAN</th>
        <th>IP Public</th>
        <th>Thao tác</th>
      </tr>
    </thead>
    <tbody></tbody>
  </nz-table>
</div>

<div *ngIf="!loading && activeCreate && !isSearch">
  <nz-card>
    <result>
      <img
        nz-image
        style="height: 100%; width: 100%"
        nzSrc="assets/imgs/blank_vm.png"
        alt=""
      />

      <button nz-button [nzType]="'primary'" (click)="navigateToCreate()">
        Khởi tạo ngay
      </button>
    </result>
  </nz-card>
</div>

<nz-modal
  [(nzVisible)]="isVisibleGanVLAN"
  nzTitle="Gắn VLAN"
  (nzOnCancel)="handleCancelGanVLAN()"
  (nzOnOk)="handleOkGanVLAN()"
  nzOkText="Xác nhận"
  nzCancelText="Hủy"
>
  <ng-container *nzModalContent>
    <nz-form-item>
      <nz-form-label>Danh sách VLAN</nz-form-label>
      <nz-form-control class="text-right">
        <nz-select
          [nzPlaceHolder]="'-- Chọn VLAN --'"
          [nzShowSearch]="true"
          style="width: 340px"
        >
          <nz-option
            *ngFor="let i of listVLAN"
            [nzLabel]="i.text"
            [nzValue]="i.id"
          />
        </nz-select>
      </nz-form-control>
    </nz-form-item>
    <nz-form-item>
      <div>
        <a (click)="clickIPAddress()"
          >Nhập IP Address <i *ngIf="!isExpand" nz-icon nzType="down"></i
          ><i *ngIf="isExpand" nz-icon nzType="up"></i
        ></a>
      </div>
    </nz-form-item>
    <nz-form-item *ngIf="isExpand">
      <nz-form-label>Danh sách Subnet</nz-form-label>
      <nz-form-control class="text-right">
        <nz-select
          [nzPlaceHolder]="'-- Chọn Subnet --'"
          [nzShowSearch]="true"
          style="width: 340px"
        >
          <nz-option
            *ngFor="let i of listSubnet"
            [nzLabel]="i.text"
            [nzValue]="i.id"
          />
        </nz-select>
      </nz-form-control>
    </nz-form-item>
    <nz-form-item *ngIf="isExpand">
      <nz-form-label>Địa chỉ IP</nz-form-label>
      <nz-form-control class="text-right">
        <nz-select
          [nzPlaceHolder]="'-- Chọn địa chỉ IP --'"
          [nzShowSearch]="true"
          style="width: 340px"
        >
          <nz-option
            *ngFor="let i of listIPAddress"
            [nzLabel]="i.text"
            [nzValue]="i.id"
          />
        </nz-select>
      </nz-form-control>
    </nz-form-item>
    <nz-alert
      nzType="warning"
      [nzMessage]="customTemplateMessageGanVLAN"
      nzShowIcon
    ></nz-alert>
    <ng-template #customTemplateMessageGanVLAN>
      <div>
        Trong trường hợp 1 Network của quý khách có nhiều subnet, quý khách cần
        lựa chọn subnet và điền IP muốn gán cho máy ảo. Khi quý khách nhạp IP
        vui lòng chọn IP chưa được sửa dụng bởi máy ảo nào và IP này thuộc dải
        IP được cấu hình trong Subnet tương ứng
      </div>
    </ng-template>
  </ng-container>
</nz-modal>

<nz-modal
  [(nzVisible)]="isVisibleGoKhoiVLAN"
  nzTitle="Gỡ khỏi VLAN"
  (nzOnCancel)="handleCancelGoKhoiVLAN()"
  (nzOnOk)="handleOkGoKhoiVLAN()"
  nzOkText="Xác nhận"
  nzCancelText="Hủy"
>
  <ng-container *nzModalContent>
    <nz-alert
      nzType="warning"
      [nzMessage]="customTemplateMessageGanVLAN"
      nzShowIcon
    ></nz-alert>
    <ng-template #customTemplateMessageGanVLAN>
      <div>
        Mỗi kết nối từ máy ảo với VLAN tương ứng với 1 IP được cấp, lựa chọn IP
        từ danh sách dưới đây để thực hiện gỡ kết nối máy ảo khỏi VLAN
      </div>
    </ng-template>
    <br />
    <nz-form-item>
      <nz-form-label>Danh sách IP trên VLAN</nz-form-label>
      <nz-form-control>
        <nz-select
          [nzPlaceHolder]="'-- Chọn địa chỉ IP --'"
          [nzShowSearch]="true"
        >
          <nz-option
            *ngFor="let i of listIPAddressOnVLAN"
            [nzLabel]="i.text"
            [nzValue]="i.id"
          />
        </nz-select>
      </nz-form-control>
    </nz-form-item>
  </ng-container>
</nz-modal>
