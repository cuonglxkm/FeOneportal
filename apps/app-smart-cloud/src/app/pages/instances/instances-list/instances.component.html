<page-header
  [breadcrumb]="breadcrumb"
  [action]="action"
  [title]="'Danh sách máy ảo'"
>
  <ng-template #breadcrumb>
    <nz-breadcrumb>
      <nz-breadcrumb-item
        ><a [routerLink]="['/']">Trang chủ</a></nz-breadcrumb-item
      >
      <nz-breadcrumb-item> Quản lý máy ảo </nz-breadcrumb-item>
    </nz-breadcrumb>
  </ng-template>
  <ng-template #action>
    <div class="alain-custom-action text-right">
      <region-select-dropdown
        (valueChanged)="onRegionChange($event)"
      ></region-select-dropdown>
      <project-select-dropdown
        [regionId]="region"
        (valueChanged)="onProjectChange($event)"
      ></project-select-dropdown>
    </div>
  </ng-template>
</page-header>

<nz-card style="border-radius: 4px" *ngIf="!activeCreate">
  <div style="margin-bottom: 20px" nz-row [nzGutter]="24">
    <div
      nz-col
      [nzLg]="12"
      [nzMd]="12"
      [nzSm]="24"
      [nzXl]="12"
      [nzXs]="24"
      [nzXXl]="12"
    >
      <nz-select
        style="width: 20%"
        [(ngModel)]="searchParam.status"
        [ngModelOptions]="{ standalone: true }"
        [nzPlaceHolder]="'Trạng thái máy ảo'"
        [nzShowSearch]="false"
        (ngModelChange)="doSearch()"
        nzSize="large"
      >
        <nz-option
          *ngFor="let i of filterStatus"
          [nzLabel]="i.text"
          [nzValue]="i.value"
        />
      </nz-select>
      <nz-input-group
        style="margin-left: 8px; width: 50%; border-radius: 8px"
        [nzPrefix]="prefixIconSearch"
        nzSize="large"
      >
        <input
          name="name"
          nz-input
          placeholder="Tìm kiếm tên, thời gian tạo ..."
          [(ngModel)]="searchParam.name"
          (keyup.enter)="doSearch()"
        />
      </nz-input-group>
      <ng-template #prefixIconSearch>
        <img
          src="assets/imgs/search.svg"
          alt=""
          style="cursor: pointer"
          nz-tooltip="Tìm kiếm"
          (click)="doSearch()"
        />
      </ng-template>
    </div>
    <div
      class="text-right p-0 m-b-0"
      nz-col
      [nzLg]="12"
      [nzMd]="12"
      [nzSm]="24"
      [nzXl]="12"
      [nzXs]="24"
      [nzXXl]="12"
    >
      <button
        nz-button
        nzType="primary"
        (click)="navigateToCreate()"
        nzSize="large"
      >
        <img
          style="padding-right: 10px; margin-top: -4px"
          src="assets/imgs/add-circle.svg"
          alt=""
        />
        <span>Tạo mới máy ảo</span>
      </button>
    </div>
  </div>
  <nz-table
    #ajaxTable3
    nzShowSizeChanger
    [nzFrontPagination]="false"
    [nzData]="dataList"
    [nzLoading]="loading"
    [nzTotal]="total"
    [(nzPageIndex)]="pageIndex"
    [(nzPageSize)]="pageSize"
    (nzPageIndexChange)="getDataList()"
    (nzPageSizeChange)="getDataList()"
    [nzVirtualItemSize]="54"
    [nzScroll]="{ x: '100%', y: '55vh' }"
  >
    <thead>
      <tr>
        <th nzLeft>Tên máy ảo</th>
        <th>Gói cấu hình</th>
        <th>Trạng thái máy ảo</th>
        <th>Trạng thái tác vụ</th>
        <th>IP LAN</th>
        <th>IP Public</th>
        <th nzRight>Thao tác</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let data of ajaxTable3.data">
        <td nzLeft>
          <a
            nz-tooltip
            nzTooltipTitle="Xem chi tiết"
            nzTooltipPlacement="bottom"
            [routerLink]="
              '/app-smart-cloud/instances/instances-detail/' + data.id
            "
            >{{ data.name }}</a
          >
        </td>
        <td nzBreakWord>
          {{ data.flavorName }}
          <!-- flavorId với flavorCloudId(mã dưới hệ thống openstack) ạ -->
        </td>
        <td nzBreakWord>
          <div style="color: #0066b3">
            {{ getStatus(data.status) }}
          </div>
        </td>
        <td nzBreakWord>{{ data.taskState }}</td>
        <td nzBreakWord>{{ data.ipPrivate }}</td>
        <td nzBreakWord>{{ data.ipPublic }}</td>
        <td nzRight>
          <img
            src="assets/imgs/create-backup.svg"
            alt=""
            (click)="navigateToCreateBackup(data.id)"
            style="cursor: pointer; margin-right: 16px"
            nz-tooltip="Tạo Backup"
          />
          <img
            src="assets/imgs/edit-2.svg"
            alt=""
            (click)="navigateToEdit(data.id)"
            style="cursor: pointer; margin-right: 16px"
            nz-tooltip="Chỉnh sửa"
          />
          <img
            src="assets/imgs/calendar-tick.svg"
            alt=""
            style="cursor: pointer; margin-right: 16px"
            nz-tooltip="Tạo lịch Backup"
          />
          <img
            nz-dropdown
            [nzDropdownMenu]="opMenu"
            src="assets/imgs/more1.svg"
            alt=""
          />
          <nz-dropdown-menu #opMenu="nzDropdownMenu">
            <ul nz-menu>
              <li nz-menu-item>Chỉnh sửa Security Group</li>
              <li nz-menu-item (click)="showHandleGanVLAN()">Gắn vào VLAN</li>
              <li nz-menu-item (click)="showHandleGoKhoiVLAN()">
                Gỡ khỏi VLAN
              </li>
              <li
                *ngIf="data.taskState != 'SHUTOFF'"
                nz-menu-item
                (click)="restartInstance(data.id)"
              >
                Khởi động lại
              </li>
              <li
                *ngIf="data.taskState != 'SHUTOFF'"
                nz-menu-item
                (click)="shutdownInstance(data.id)"
              >
                Tắt máy ảo
              </li>
              <li
                *ngIf="data.taskState == 'SHUTOFF'"
                nz-menu-item
                (click)="startInstance(data.id)"
              >
                Bật máy ảo
              </li>
              <li nz-menu-item (click)="rescueInstance(data.id)">RESCUE</li>
            </ul>
          </nz-dropdown-menu>
        </td>
      </tr>
    </tbody>
  </nz-table>
</nz-card>

<div *ngIf="!loading && activeCreate">
  <nz-card>
    <result>
      <img
        style="height: 100%; width: 100%"
        src="assets/imgs/blank_vm.png"
        alt=""
      />

      <button
        nz-button
        [nzType]="'primary'"
        (click)="navigateToCreate()"
        nzSize="large"
      >
        Khởi tạo ngay
      </button>
    </result>
  </nz-card>
</div>

<nz-modal
  [(nzVisible)]="isVisibleGanVLAN"
  nzTitle="Gắn VLAN"
  (nzOnCancel)="handleCancelGanVLAN()"
  (nzOnOk)="handleOkGanVLAN()"
  nzOkText="Xác nhận"
  nzCancelText="Hủy"
>
  <ng-container *nzModalContent>
    <nz-form-item>
      <nz-form-label>Danh sách VLAN</nz-form-label>
      <nz-form-control class="text-right">
        <nz-select
          [nzPlaceHolder]="'-- Chọn VLAN --'"
          [nzShowSearch]="true"
          style="width: 340px"
        >
          <nz-option
            *ngFor="let i of listVLAN"
            [nzLabel]="i.text"
            [nzValue]="i.id"
          />
        </nz-select>
      </nz-form-control>
    </nz-form-item>
    <nz-form-item>
      <div>
        <a (click)="clickIPAddress()"
          >Nhập IP Address <i *ngIf="!isExpand" nz-icon nzType="down"></i
          ><i *ngIf="isExpand" nz-icon nzType="up"></i
        ></a>
      </div>
    </nz-form-item>
    <nz-form-item *ngIf="isExpand">
      <nz-form-label>Danh sách Subnet</nz-form-label>
      <nz-form-control class="text-right">
        <nz-select
          [nzPlaceHolder]="'-- Chọn Subnet --'"
          [nzShowSearch]="true"
          style="width: 340px"
        >
          <nz-option
            *ngFor="let i of listSubnet"
            [nzLabel]="i.text"
            [nzValue]="i.id"
          />
        </nz-select>
      </nz-form-control>
    </nz-form-item>
    <nz-form-item *ngIf="isExpand">
      <nz-form-label>Địa chỉ IP</nz-form-label>
      <nz-form-control class="text-right">
        <nz-select
          [nzPlaceHolder]="'-- Chọn địa chỉ IP --'"
          [nzShowSearch]="true"
          style="width: 340px"
        >
          <nz-option
            *ngFor="let i of listIPAddress"
            [nzLabel]="i.text"
            [nzValue]="i.id"
          />
        </nz-select>
      </nz-form-control>
    </nz-form-item>
    <nz-alert
      nzType="warning"
      [nzMessage]="customTemplateMessageGanVLAN"
      nzShowIcon
    ></nz-alert>
    <ng-template #customTemplateMessageGanVLAN>
      <div>
        Trong trường hợp 1 Network của quý khách có nhiều Subnet, quý khách cần
        lựa chọn Subnet và điền IP muốn gán cho máy ảo. Khi quý khách nhạp IP
        vui lòng chọn IP chưa được sử dụng bởi máy ảo nào và IP này thuộc dải IP
        được cấu hình trong Subnet tương ứng
      </div>
    </ng-template>
  </ng-container>
</nz-modal>

<nz-modal
  [(nzVisible)]="isVisibleGoKhoiVLAN"
  nzTitle="Gỡ khỏi VLAN"
  (nzOnCancel)="handleCancelGoKhoiVLAN()"
  (nzOnOk)="handleOkGoKhoiVLAN()"
  nzOkText="Xác nhận"
  nzCancelText="Hủy"
>
  <ng-container *nzModalContent>
    <nz-alert
      nzType="warning"
      [nzMessage]="customTemplateMessageGanVLAN"
      nzShowIcon
    ></nz-alert>
    <ng-template #customTemplateMessageGanVLAN>
      <div>
        Mỗi kết nối từ máy ảo với VLAN tương ứng với 1 IP được cấp, lựa chọn IP
        từ danh sách dưới đây để thực hiện gỡ kết nối máy ảo khỏi VLAN
      </div>
    </ng-template>
    <br />
    <nz-form-item>
      <nz-form-label>Danh sách IP trên VLAN</nz-form-label>
      <nz-form-control>
        <nz-select
          [nzPlaceHolder]="'-- Chọn địa chỉ IP --'"
          [nzShowSearch]="true"
        >
          <nz-option
            *ngFor="let i of listIPAddressOnVLAN"
            [nzLabel]="i.text"
            [nzValue]="i.id"
          />
        </nz-select>
      </nz-form-control>
    </nz-form-item>
  </ng-container>
</nz-modal>
