<nz-card [nzBordered]="false">
  <span class="title-card">Chọn kiểu gán Permissions cho User</span>
  <nz-row
    [nzGutter]="{ xs: 24, sm: 24, md: 24, lg: 24 }"
    style="margin-top: 10px; border-radius: 4px"
  >
    <nz-radio-group
      style="width: 100%; display: inline-flex"
      name="selectedPasswordOrSSHkey"
    >
      <div nz-col [nzLg]="8" [nzMd]="24" [nzSm]="24" [nzXl]="8" [nzXs]="24">
        <nz-card
          style="border-radius: 4px"
          [ngStyle]="{
            border: activeBlockAddUsertoGroup
              ? '1px solid #035DED'
              : '1px solid #DADADA',
            height: cardHeight
          }"
        >
          <nz-card-meta
            [nzAvatar]="nzAvatarselected1"
            [nzTitle]="nzTitleselected1"
            [nzDescription]="nzDescriptionselected1"
          >
            <ng-template #nzAvatarselected1>
              <input
                type="radio"
                [checked]="activeBlockAddUsertoGroup"
                (click)="initAddUsertoGroup()"
              />
            </ng-template>
            <ng-template #nzTitleselected1>
              <b>Thêm User vào Group</b>
            </ng-template>
            <ng-template #nzDescriptionselected1>
              <ellipsis class="text-custom"
                >Thêm người dùng vào nhóm hiện có hoặc tạo nhóm mới. Nên sử dụng
                nhóm để quản lý quyền của người dùng theo chức năng công
                việc.</ellipsis
              >
            </ng-template>
          </nz-card-meta>
        </nz-card>
      </div>
      <div nz-col [nzLg]="8" [nzMd]="24" [nzSm]="24" [nzXl]="8" [nzXs]="24">
        <nz-card
          style="border-radius: 4px"
          [ngStyle]="{
            border: activeBlockCopyPolicies
              ? '1px solid #035DED'
              : '1px solid #DADADA',
            height: cardHeight
          }"
        >
          <nz-card-meta
            [nzAvatar]="nzAvatarselected2"
            [nzTitle]="nzTitleselected2"
            [nzDescription]="nzDescriptionselected2"
          >
            <ng-template #nzAvatarselected2>
              <input
                type="radio"
                [checked]="activeBlockCopyPolicies"
                (click)="initCopyPolicies()"
              />
            </ng-template>
            <ng-template #nzTitleselected2>
              <b>Sao chép Policies </b>
            </ng-template>
            <ng-template #nzDescriptionselected2>
              <ellipsis class="text-custom">
                Sao chép tất cả tư cách thành viên nhóm, policies được quản lý
                đỉnh kèm từ người dùng hiện có.</ellipsis
              >
            </ng-template>
          </nz-card-meta>
        </nz-card>
      </div>
      <div nz-col [nzLg]="8" [nzMd]="24" [nzSm]="24" [nzXl]="8" [nzXs]="24">
        <nz-card
          style="border-radius: 4px"
          [ngStyle]="{
            border: activeBlockAttachPolicies
              ? '1px solid #035DED'
              : '1px solid #DADADA',
            height: cardHeight,
          }"
        >
          <nz-card-meta
            [nzAvatar]="nzAvatarselected3"
            [nzTitle]="nzTitleselected3"
            [nzDescription]="nzDescriptionselected3"
          >
            <ng-template #nzAvatarselected3>
              <input
                type="radio"
                [checked]="activeBlockAttachPolicies"
                (click)="initAttachPolicies()"
              />
            </ng-template>
            <ng-template #nzTitleselected3>
              <b>Đính kèm Policies trực tiếp</b>
            </ng-template>
            <ng-template #nzDescriptionselected3>
              <ellipsis class="text-custom">
                Đính kèm policies được quản lý trực tiếp cho người
                dùng.</ellipsis
              >
            </ng-template>
          </nz-card-meta>
        </nz-card>
      </div>
    </nz-radio-group>
  </nz-row>
</nz-card>

<nz-card
  *ngIf="activeBlockAddUsertoGroup"
  [nzBordered]="false"
  style="border-radius: 4px"
>
  <div
    style="margin-bottom: 20px"
    nz-row
    [nzGutter]="{ xs: 8, sm: 16, md: 24, lg: 24 }"
  >
    <div
      nz-col
      [nzLg]="12"
      [nzMd]="12"
      [nzSm]="24"
      [nzXl]="12"
      [nzXs]="24"
      [nzXXl]="12"
    >
      <span class="table-title">Thông tin Groups</span>
    </div>
    <div
      class="text-right p-0 m-b-0"
      nz-col
      [nzLg]="12"
      [nzMd]="12"
      [nzSm]="24"
      [nzXl]="12"
      [nzXs]="24"
      [nzXXl]="12"
    >
      <nz-input-group
        style="margin-right: 8px; width: 50%; border-radius: 8px"
        [nzPrefix]="prefixIconSearch"
        nzSize="large"
      >
        <input
          name="name"
          nz-input
          placeholder="Tìm kiếm tên, thời gian tạo ..."
          [(ngModel)]="searchParam"
        />
      </nz-input-group>
      <ng-template #prefixIconSearch>
        <img
          src="assets/imgs/search.svg"
          alt=""
          style="cursor: pointer"
          nz-tooltip="Tìm kiếm"
          (click)="getGroup()"
        />
      </ng-template>
      <button
        style="border: none; border-radius: 8px"
        nz-button
        (click)="reloadGroupTable()"
      >
        <img style="margin-top: -4px" src="assets/imgs/refresh.svg" alt="" />
      </button>
      <button
        nz-button
        nzType="primary"
        (click)="navigateToCreateGroup()"
      >
        <img
          style="padding-right: 10px; margin-top: -4px"
          src="assets/imgs/add-circle.svg"
          alt=""
        />
        <span>Tạo mới</span>
      </button>
    </div>
  </div>
  <nz-table
    #rowSelectionTable
    nzShowSizeChanger
    [nzScroll]="{ x: '100%', y: '250px' }"
    [nzFrontPagination]="false"
    [nzData]="listOfGroups"
    (nzCurrentPageDataChange)="onCurrentPageDataChangeGroup($event)"
    [nzLoading]="loading"
    [nzTotal]="totalGroup"
    [(nzPageIndex)]="pageIndex"
    [(nzPageSize)]="pageSize"
    (nzPageIndexChange)="getGroup()"
    (nzPageSizeChange)="getGroup()"
  >
    <thead>
      <tr>
        <th
          [nzChecked]="checkedGroup"
          [nzIndeterminate]="indeterminateGroup"
          nzLabel="Select all group"
          [nzWidth]="'50px'"
          (nzCheckedChange)="onAllCheckedGroup($event)"
          nzLeft
        ></th>
        <th>Tên Group</th>
        <th>Số lượng User</th>
        <th>Attached policies</th>
        <th>Thời gian tạo</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let item of listOfGroups; let i = index">
        <td
          [nzChecked]="mapOfCheckedGroup.has(item.name)"
          (nzCheckedChange)="onItemCheckedGroup(item, $event)"
          nzLeft
        ></td>
        <td nzLeft>
          <a
            nz-tooltip
            nzTooltipTitle="Xem chi tiết"
            nzTooltipPlacement="bottom"
            [routerLink]="'/app-smart-cloud/iam/user-group/' + item.name"
            >{{ item.name }}</a
          >
        </td>
        <td class="fieldColor">{{ item.numberOfUser }}</td>
        <td *ngIf="item.policies == null || item.policies.length == 0">None</td>
        <td
          class="fieldColor"
          *ngIf="item.policies != null && item.policies.length == 1"
        >
          {{ item.policies[0] }}
        </td>
        <td
          class="fieldColor"
          *ngIf="item.policies != null && item.policies.length == 2"
        >
          {{ item.policies[0] }}, {{ item.policies[1] }}
        </td>
        <td
          class="fieldColor"
          *ngIf="item.policies != null && item.policies.length > 2"
        >
          {{ item.policies[0] }}, {{ item.policies[1] }}
          <span class="nameField">
            and {{ item.policies.length - 2 }} policies
          </span>
        </td>
        <td>{{ item.createdDate | date : 'HH:mm:ss dd/MM/yyyy' }}</td>
      </tr>
    </tbody>
  </nz-table>
</nz-card>

<nz-card
  *ngIf="activeBlockCopyPolicies"
  [nzBordered]="false"
  style="border-radius: 4px"
>
  <div
    style="margin-bottom: 20px"
    nz-row
    [nzGutter]="{ xs: 8, sm: 16, md: 24, lg: 24 }"
  >
    <div
      nz-col
      [nzLg]="16"
      [nzMd]="16"
      [nzSm]="24"
      [nzXl]="16"
      [nzXs]="24"
      [nzXXl]="16"
    >
      <span class="table-title">Thông tin Users</span>
    </div>
    <div
      class="text-right p-0 m-b-0"
      nz-col
      [nzLg]="8"
      [nzMd]="8"
      [nzSm]="24"
      [nzXl]="8"
      [nzXs]="24"
      [nzXXl]="8"
    >
      <nz-input-group
        style="margin-right: 8px; width: 80%; border-radius: 8px"
        [nzPrefix]="prefixIconSearch"
        nzSize="large"
      >
        <input
          name="name"
          nz-input
          placeholder="Tìm kiếm tên, thời gian tạo ..."
          [(ngModel)]="searchParam"
        />
      </nz-input-group>
      <ng-template #prefixIconSearch>
        <img
          src="assets/imgs/search.svg"
          alt=""
          style="cursor: pointer"
          nz-tooltip="Tìm kiếm"
          (click)="getCopyUserPlicies()"
        />
      </ng-template>
      <button
        style="border: none; border-radius: 8px"
        nz-button
        (click)="reloadUserTable()"
      >
        <img style="margin-top: -4px" src="assets/imgs/refresh.svg" alt="" />
      </button>
    </div>
  </div>
  <nz-table
    #rowSelectionTable
    nzShowSizeChanger
    [nzScroll]="{ x: '100%', y: '250px' }"
    [nzFrontPagination]="false"
    [nzData]="listOfUsers"
    (nzCurrentPageDataChange)="onCurrentPageDataChangeUser($event)"
    [nzLoading]="loading"
    [nzTotal]="totalUser"
    [(nzPageIndex)]="pageIndex"
    [(nzPageSize)]="pageSize"
    (nzPageIndexChange)="getCopyUserPlicies()"
    (nzPageSizeChange)="getCopyUserPlicies()"
  >
    <thead>
      <tr>
        <th
          [nzChecked]="checkedUser"
          [nzIndeterminate]="indeterminateUser"
          nzLabel="Select all user"
          [nzWidth]="'50px'"
          (nzCheckedChange)="onAllCheckedUser($event)"
          nzLeft
        ></th>
        <th>Tên User</th>
        <th>Groups</th>
        <th>Attached policies</th>
        <th>Thời gian tạo</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let item of listOfUsers; let i = index">
        <td
          [nzChecked]="mapOfCheckedUser.has(item.userName)"
          (nzCheckedChange)="onItemCheckedUser(item, $event)"
          nzLeft
        ></td>
        <td nzLeft>
          <a
            nz-tooltip
            nzTooltipTitle="Xem chi tiết"
            nzTooltipPlacement="bottom"
            [routerLink]="'/app-smart-cloud/users/detail/' + item.userName"
            >{{ item.userName }}</a
          >
        </td>
        <td *ngIf="item.userGroups.length == 0">None</td>
        <td class="fieldColor" *ngIf="item.userGroups.length == 1">
          {{ item.userGroups[0] }}
        </td>
        <td class="fieldColor" *ngIf="item.userGroups.length == 2">
          {{ item.userGroups[0] }}, {{ item.userGroups[1] }}
        </td>
        <td class="fieldColor" *ngIf="item.userGroups.length > 2">
          {{ item.userGroups[0] }}, {{ item.userGroups[1] }}
          <span class="nameField">
            and {{ item.userGroups.length - 2 }} groups
          </span>
        </td>
        <td *ngIf="item.userPolicies.length == 0">None</td>
        <td class="fieldColor" *ngIf="item.userPolicies.length == 1">
          {{ item.userPolicies[0] }}
        </td>
        <td class="fieldColor" *ngIf="item.userPolicies.length == 2">
          {{ item.userPolicies[0] }}, {{ item.userPolicies[1] }}
        </td>
        <td class="fieldColor" *ngIf="item.userPolicies.length > 2">
          {{ item.userPolicies[0] }}, {{ item.userPolicies[1] }}
          <span class="nameField">
            and {{ item.userPolicies.length - 2 }} policies
          </span>
        </td>
        <td>{{ item.createdDate | date : 'HH:mm:ss dd/MM/yyyy' }}</td>
      </tr>
    </tbody>
  </nz-table>
</nz-card>

<nz-card
  *ngIf="activeBlockAttachPolicies"
  [nzBordered]="false"
  style="border-radius: 4px"
>
  <form nz-form>
    <div
      style="margin-bottom: 20px"
      nz-row
      [nzGutter]="{ xs: 8, sm: 16, md: 24, lg: 24 }"
    >
      <div
        nz-col
        [nzLg]="12"
        [nzMd]="12"
        [nzSm]="24"
        [nzXl]="12"
        [nzXs]="24"
        [nzXXl]="12"
      >
        <span class="table-title">Thông tin Permissions policies</span>
      </div>
      <div
        class="text-right p-0 m-b-0"
        nz-col
        [nzLg]="12"
        [nzMd]="12"
        [nzSm]="24"
        [nzXl]="12"
        [nzXs]="24"
        [nzXXl]="12"
      >
        <nz-input-group
          style="margin-right: 8px; width: 50%; border-radius: 8px"
          [nzPrefix]="prefixIconSearch"
          nzSize="large"
        >
          <input
            name="name"
            nz-input
            placeholder="Tìm kiếm tên, thời gian tạo ..."
            [(ngModel)]="searchParam"
          />
        </nz-input-group>
        <ng-template #prefixIconSearch>
          <img
            src="assets/imgs/search.svg"
            alt=""
            style="cursor: pointer"
            nz-tooltip="Tìm kiếm"
            (click)="getPermissionPolicies()"
          />
        </ng-template>
        <button
          style="border: none; border-radius: 8px"
          nz-button
          (click)="reloadPolicyTable()"
        >
          <img style="margin-top: -4px" src="assets/imgs/refresh.svg" alt="" />
        </button>
        <button
          nz-button
          nzType="primary"
          (click)="navigateToCreatePolicy()"
        >
          <img
            style="padding-right: 10px; margin-top: -4px"
            src="assets/imgs/add-circle.svg"
            alt=""
          />
          <span>Tạo mới</span>
        </button>
      </div>
    </div>
  </form>
  <nz-table
    #rowSelectionTable
    nzShowSizeChanger
    [nzScroll]="{ x: '100%', y: '250px' }"
    [nzFrontPagination]="false"
    [nzData]="listOfPolicies"
    (nzCurrentPageDataChange)="onCurrentPageDataChangePolicy($event)"
    [nzLoading]="loading"
    [nzTotal]="totalPolicy"
    [(nzPageIndex)]="pageIndex"
    [(nzPageSize)]="pageSize"
    (nzPageIndexChange)="getPermissionPolicies()"
    (nzPageSizeChange)="getPermissionPolicies()"
  >
    <thead>
      <tr>
        <th
          [nzChecked]="checkedPolicy"
          [nzIndeterminate]="indeterminatePolicy"
          nzLabel="Select all Policy"
          [nzWidth]="'50px'"
          (nzCheckedChange)="onAllCheckedPolicy($event)"
          nzLeft
        ></th>
        <th>Tên Policy</th>
        <th>Type</th>
        <th>Attached entities</th>
      </tr>
    </thead>
    <tbody>
      <ng-container *ngFor="let item of listOfPolicies; let i = index">
        <tr>
          <td
            [nzChecked]="setOfCheckedPolicy.has(item.name)"
            (nzCheckedChange)="onItemCheckedPolicy(item.name, $event)"
            nzLeft
          ></td>
          <td
            [nzExpand]="expandSet.has(item.name)"
            (nzExpandChange)="onExpandChange(item.name, $event)"
          >
            <a
              nz-tooltip
              nzTooltipTitle="Xem chi tiết"
              nzTooltipPlacement="bottom"
              [routerLink]="'/app-smart-cloud/policy/detail/' + item.name"
              >{{ item.name }}</a
            >
          </td>
          <td>{{ item.type }}</td>
          <td class="fieldColor">{{ item.attachedEntities }}</td>
        </tr>
        <tr [nzExpand]="expandSet.has(item.name)">
          <div class="json-viewer-bg">
            <button
              (click)="copyText(item)"
              style="z-index: 1; position: absolute; right: 20px; top: 21px"
            >
              <span nz-icon nzType="copy" nzTheme="outline"></span> Copy JSON
            </button>
            <ngx-json-viewer
              [json]="item"
              style="position: relative"
            ></ngx-json-viewer>
          </div>
        </tr>
      </ng-container>
    </tbody>
  </nz-table>
</nz-card>
