<page-header [breadcrumb]="breadcrumb"
             [action]="action"
             [title]="'Chỉnh sửa L7 Policy'" xmlns="http://www.w3.org/1999/html">
  <ng-template #breadcrumb>
    <nz-breadcrumb>
      <nz-breadcrumb-item>Trang chủ</nz-breadcrumb-item>
      <nz-breadcrumb-item>
        Dịch vụ hạ tầng
      </nz-breadcrumb-item>
      <nz-breadcrumb-item>
        <a routerLink="/app-smart-cloud/load-balancer/list">Load Balancer</a>
      </nz-breadcrumb-item>
      <nz-breadcrumb-item>
        <a routerLink="/app-smart-cloud/load-balancer/detail/{{ idLoadBalancer }}">Chi tiết Load Balancer</a>
      </nz-breadcrumb-item>
      <nz-breadcrumb-item>
        <a routerLink="/app-smart-cloud/load-balancer/{{ idLoadBalancer }}/listener/{{ idListener }}">Chi tiết
          Listener</a>
      </nz-breadcrumb-item>
      <nz-breadcrumb-item>Chỉnh sửa L7 Policy</nz-breadcrumb-item>
    </nz-breadcrumb>
  </ng-template>
  <ng-template #action>
    <div class="alain-custom-action text-right">
      <region-select-dropdown (valueChanged)="regionChanged($event)"></region-select-dropdown>
      <project-select-dropdown (valueChanged)="projectChanged($event)"
                               (userChanged)="userChanged($event)"
                               [regionId]="region"></project-select-dropdown>
    </div>
  </ng-template>
</page-header>
<nz-content>

  <nz-row nzGutter="24">
    <nz-col nzSpan="16">
      <nz-card style="border-radius: 8px;">
        <span class="text-card-header">Thông tin L7 Policy</span>
        <form nz-form [formGroup]="validateForm" nzLayout="vertical">
          <nz-form-item style="margin-top: 20px;">
            <nz-form-label>
              <span>Tên L7 Policy (<span style="color: red">*</span>)</span>
              <img nz-popover
                   [nzPopoverContent]="'Tên L7 Policy không được chứa dấu cách, dấu tiếng việt và ký tự đặc biệt, tối đa 50 ký tự'"
                   nzPopoverPlacement="bottom" style="margin-left: 5px;"
                   src="assets/imgs/pajamas_question.svg" alt="" />
            </nz-form-label>
            <nz-form-control nzDisableAutoTips [nzErrorTip]="nameL7ErrorTpl">
              <input nz-input class="input-custom" [maxlength]="50" formControlName="nameL7" [placeholder]="'Tên L7 policy'" appAutofocus/>
              <ng-template #nameL7ErrorTpl let-control>
                <ng-container *ngIf="control.hasError('required')">Vui lòng nhập thông tin</ng-container>
                <ng-container *ngIf="control.hasError('pattern')">không được chứa dấu cách, dấu tiếng việt và ký tự đặc biệt</ng-container>
                <ng-container *ngIf="control.hasError('duplicateName')">Tên L7 Policy đã tồn tại, vui lòng nhập tên khác</ng-container>
              </ng-template>
            </nz-form-control>
          </nz-form-item>
          <nz-form-item>
            <nz-form-label>
              <span>Hành động thực thi (<span style="color: red">*</span>)</span>
              <img nz-popover
                   [nzPopoverContent]="popover"
                   nzPopoverPlacement="right" style="margin-left: 5px;"
                   src="assets/imgs/pajamas_question.svg" alt="" />
              <ng-template #popover>
                <span class="text-label">Hành động được thực thi khi L7 Policy đáp ứng điều kiện. Các hành động:<br>
                REJECT: Yêu cầu bị từ chối với một mã phản hồi thích hợp và không được chuyển tiếp đến bất kỳ nhóm phụ trợ nào.<br>
                REDIRECT_TO_URL: Yêu cầu được gửi một chuyển hướng HTTP đến.<br>
                URL được xác định trong url tham số.</span>
              </ng-template>
            </nz-form-label>
            <nz-form-control nzDisableAutoTips>
              <nz-select formControlName="action" nzSize="large" (ngModelChange)="onActionChange()" [nzPlaceHolder]="'Chọn hành động thực thi'">
                <nz-option *ngFor="let option of actionList" [nzValue]="option.value" [nzLabel]="option.label"></nz-option>
              </nz-select>
            </nz-form-control>
          </nz-form-item>
          <nz-form-item *ngIf="validateForm.controls.action.value === 'REDIRECT_TO_POOL'">
            <nz-form-label>
              <span>Chọn Pool (<span style="color: red;">*</span>)</span>
              <img nz-popover
                   [nzPopoverContent]="'Các request đáp ứng được policy này sẽ chuyển hướng tới pool này'"
                   nzPopoverPlacement="right" style="margin-left: 5px;"
                   src="assets/imgs/pajamas_question.svg" alt="" />
            </nz-form-label>
            <nz-form-control nzDisableAutoTips>
              <nz-select formControlName="pool" nzSize="large" [nzPlaceHolder]="'Chọn Pool'">
                <nz-option *ngFor="let option of listPool" [nzValue]="option.id" [nzLabel]="option.name"></nz-option>
              </nz-select>
            </nz-form-control>
          </nz-form-item>
          <nz-form-item *ngIf="validateForm.controls.action.value === 'REDIRECT_TO_URL'">
            <nz-form-label>
              <span>URL (<span style="color: red;">*</span>)</span>
              <img nz-popover
                   [nzPopoverContent]="'Các request đáp ứng được policy sẽ được chuyển hướng tới URL này'"
                   nzPopoverPlacement="right" style="margin-left: 5px;"
                   src="assets/imgs/pajamas_question.svg" alt="" />
            </nz-form-label>
            <nz-form-control nzDisableAutoTips [nzErrorTip]="urlErrorTpl">
              <input nz-input class="input-custom" formControlName="url" [placeholder]="'Nhập url'" />
              <ng-template #urlErrorTpl let-control>
                <ng-container *ngIf="control.hasError('required')">Vui lòng nhập url</ng-container>
                <ng-container *ngIf="control.hasError('invalidUrl')">Vui lòng nhập đúng định dạng url ftp/http/https:</ng-container>
              </ng-template>
            </nz-form-control>
          </nz-form-item>
          <nz-form-item>
            <nz-form-label>
              <span>Độ ưu tiên (<span style="color: red">*</span>)</span>
              <img nz-popover
                   [nzPopoverContent]="'Vị trí của L7 Policy đối với Listener.\n'+
                                        'Có thể nhập vị trí đã tồn tại.'"
                   nzPopoverPlacement="bottom" style="margin-left: 5px;"
                   src="assets/imgs/pajamas_question.svg" alt="" />
            </nz-form-label>
            <nz-form-control nzDisableAutoTips>
              <nz-input-number style="width: 100%; margin-left: 0;" [nzMin]="1" [nzStep]="1" class="input-custom" formControlName="prioritize" />
            </nz-form-control>
          </nz-form-item>
          <nz-form-item>
            <div style="display: flex;">
              <span class="text-label">Trạng thái (<span style="color: red;">*</span>)</span>
              <img style="margin-left: 10px"
                   nz-popover [nzPopoverContent]="'Trạng thái của L7 Policy: Bật/Tắt'"
                   nzPopoverPlacement="bottom"
                   src="assets/imgs/pajamas_question.svg" alt="" />
              <nz-switch style="margin-left: 15px;" formControlName="status" (ngModelChange)="onSwitchStatus()" nzCheckedChildren="BẬT"
                         nzUnCheckedChildren="TẮT"></nz-switch>
            </div>
          </nz-form-item>
          <nz-form-item>
            <nz-form-label nzFor="description">
              <div class="label">
                <span>{{ 'app.service.description' | i18n }}</span>
              </div>
            </nz-form-label>
            <nz-form-control nzDisableAutoTips [nzErrorTip]="descriptionErrorTpl">
              <textarea nz-input class="input-custom"
                        formControlName="description"
                        [placeholder]="'app.input.des' | i18n" [maxLength]="255"
                        [nzAutosize]="{ minRows: 3, maxRows: 5 }"
              (keydown.enter)="focusOkButton($event)"></textarea>
              <ng-template #descriptionErrorTpl let-control>
                <ng-container *ngIf="control.hasError('maxlength')">{{ 'volume.notification.input.description.maxLength' | i18n }}</ng-container>
              </ng-template>
            </nz-form-control>
          </nz-form-item>
        </form>
      </nz-card>
    </nz-col>
    <nz-col nzSpan="8">
      <nz-card style="border-radius: 8px;">
        <span class="text-card-header">Thông tin cấu hình</span>
        <div style="margin-top: 10px" class="text-value">Tên L7 Policy</div>
        <div style="margin-top: 10px" class="text-label">
          {{ validateForm.controls.nameL7.getRawValue() }}
        </div>
        <nz-divider style="margin: 10px 0" nzType="horizontal"></nz-divider>
        <div style="margin-top: 10px" class="text-value">Hành động thực thi</div>
        <div style="margin-top: 10px" class="text-label">
          {{ validateForm.controls.action.getRawValue() }}
        </div>
        <nz-divider style="margin: 10px 0" nzType="horizontal"></nz-divider>
        <div style="margin-top: 10px" class="text-value">Độ ưu tiên</div>
        <div style="margin-top: 10px" class="text-label">
          {{ validateForm.controls.prioritize.getRawValue() }}
        </div>
        <nz-divider style="margin: 10px 0" nzType="horizontal"></nz-divider>
        <nz-row>
          <nz-col style="width: 100%">
            <button style="width: 100%" nz-button nzSize="large" nzType="primary" [disabled]="validateForm.invalid" (click)="doUpdateL7Policy()">
              <span nz-icon nzType="edit" nzTheme="outline" style="margin-right: 5px; padding-bottom: 5px;"></span>
              <span [style.color]="validateForm.invalid ? 'gray' : 'white'">Chỉnh sửa</span>
            </button>
          </nz-col>
        </nz-row>
      </nz-card>
    </nz-col>
  </nz-row>


</nz-content>
